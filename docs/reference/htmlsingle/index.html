<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Security SAML Extension</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book"><div class="titlepage"><div><div><h1 class="title"><a name="spring-security-reference-guide"></a>Spring Security SAML Extension</h1></div><div><h2 class="subtitle">Reference Documentation</h2></div><div><div class="authorgroup"><h2>Authors</h2>
			<span class="author">Vladim&iacute;r Sch&auml;fer</span>
		</div></div><div><p class="releaseinfo">1.0.2.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2009-2014 <a class="ulink" href="mailto:vladimir.schafer@gmail.com" target="_top">Vladim&iacute;r Sch&auml;fer</a></p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#getting-started">I. Getting Started</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#section-what-this-manual-covers">1.1. What this manual covers</a></span></dt><dt><span class="section"><a href="#section-when-to-use">1.2. When to use Spring Security SAML Extension</a></span></dt><dt><span class="section"><a href="#section-features-and-profiles">1.3. Features and supported profiles</a></span></dt><dt><span class="section"><a href="#section-requirements">1.4. Requirements</a></span></dt><dt><span class="section"><a href="#section-source">1.5. Source code</a></span></dt><dt><span class="section"><a href="#section-build">1.6. Builds</a></span></dt><dt><span class="section"><a href="#section-license">1.7. License</a></span></dt><dt><span class="section"><a href="#section-issue-tracking">1.8. Issue tracking</a></span></dt><dt><span class="section"><a href="#section-contributions">1.9. Contributions</a></span></dt><dt><span class="section"><a href="#section-commercial-support">1.10. Commercial support</a></span></dt><dt><span class="section"><a href="#section-support">1.11. Community support</a></span></dt><dt><span class="section"><a href="#section-dependencies">1.12. Dependencies</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-whats-new">2. What's new</a></span></dt><dd><dl><dt><span class="section"><a href="#section-whats-new-highlight-1.0.1">2.1. New features, improvements and fixes in 1.0.1.FINAL</a></span></dt><dt><span class="section"><a href="#section-whats-new-highlight-1.0.0">2.2. New features, improvements and fixes in 1.0.0.FINAL</a></span></dt><dt><span class="section"><a href="#section-whats-new-code-changes-1.0.0">2.3. Important code changes in 1.0.0.FINAL</a></span></dt></dl></dd><dt><span class="chapter"><a href="#glossary">3. Glossary</a></span></dt><dt><span class="chapter"><a href="#chapter-quick-start">4. Quick start guide</a></span></dt><dd><dl><dt><span class="section"><a href="#quick-start-prerequisites">4.1. Pre-requisites</a></span></dt><dt><span class="section"><a href="#quick-start-steps">4.2. Installation steps</a></span></dt><dd><dl><dt><span class="section"><a href="#quick-start-download">4.2.1. Downloading sample application</a></span></dt><dt><span class="section"><a href="#quick-start-idp-metadata">4.2.2. Configuration of IDP metadata</a></span></dt><dt><span class="section"><a href="#quick-start-sp-metadata">4.2.3. Generation of SP metadata</a></span></dt><dt><span class="section"><a href="#quick-start-compilation">4.2.4. Compilation</a></span></dt><dt><span class="section"><a href="#quick-start-deploy">4.2.5. Deployment</a></span></dt><dt><span class="section"><a href="#quick-start-sp-metadata-to-idp">4.2.6. Uploading of SP metadata to the IDP</a></span></dt></dl></dd><dt><span class="section"><a href="#quick-start-testing">4.3. Testing single sign-on and single logout</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#configuration">II. Configuring SAML Extension</a></span></dt><dd><dl><dt><span class="chapter"><a href="#configuration-overview">5. Overview</a></span></dt><dt><span class="chapter"><a href="#configuration-integration">6. Integration to applications</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-integration-maven">6.1. Maven dependency</a></span></dt><dt><span class="section"><a href="#configuration-integration-bean-definitions">6.2. Bean definitions</a></span></dt><dt><span class="section"><a href="#configuration-java">6.3. Java-based configuration</a></span></dt><dt><span class="section"><a href="#configuration-integration-spring-security">6.4. Spring Security integration</a></span></dt><dt><span class="section"><a href="#error-handling">6.5. Error handling</a></span></dt><dt><span class="section"><a href="#logging">6.6. Logging</a></span></dt></dl></dd><dt><span class="chapter"><a href="#configuration-metadata">7. Metadata configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-metadata-sp">7.1. Service provider metadata</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-metadata-sp-generation">7.1.1. Automatic metadata generation</a></span></dt><dt><span class="section"><a href="#configuration-metadata-sp-import">7.1.2. Pre-configured metadata</a></span></dt><dt><span class="section"><a href="#configuration-metadata-sp-display">7.1.3. Downloading metadata</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-metadata-idp">7.2. Identity provider metadata</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-metadata-idp-file">7.2.1. File-based metadata provider</a></span></dt><dt><span class="section"><a href="#configuration-metadata-idp-http">7.2.2. HTTP-based metadata provider</a></span></dt><dt><span class="section"><a href="#configuration-metadata-https">7.2.3. HTTP-based metadata provider with SSL</a></span></dt><dt><span class="section"><a href="#configuration-metadata-idp-signature">7.2.4. Metadata signature verification</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-metadata-extended">7.3. Extended metadata</a></span></dt><dt><span class="section"><a href="#configuration-entity-alias">7.4. Multi-tenancy and entity alias</a></span></dt></dl></dd><dt><span class="chapter"><a href="#security">8. Security configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-key-management">8.1. Key management</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-key-management-jks">8.1.1. Sample JKS keystore</a></span></dt><dt><span class="section"><a href="#configuration-key-management-private-keys">8.1.2. Generating and importing private keys</a></span></dt><dt><span class="section"><a href="#configuration-key-management-public-keys">8.1.3. Importing public keys</a></span></dt><dt><span class="section"><a href="#configuration-key-management-ssl-keys">8.1.4. Loading SSL/TLS certificates</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-security-profiles">8.2. Security profiles</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-security-profiles-metaiop">8.2.1. Metadata interoperability profile (MetaIOP)</a></span></dt><dt><span class="section"><a href="#configuration-security-profiles-pkix">8.2.2. PKIX profile</a></span></dt><dt><span class="section"><a href="#configuration-security-profiles-customization">8.2.3. Custom profile</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-security-profiles-hostnames">8.3. Hostname verification for HTTPS connections</a></span></dt></dl></dd><dt><span class="chapter"><a href="#configuration-sso">9. Single sign-on configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-discovery">9.1. IDP selection and discovery</a></span></dt><dt><span class="section"><a href="#configuration-sso-process">9.2. Single sign-on process</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-sso-process-sp-init">9.2.1. Service provider initialized SSO</a></span></dt><dt><span class="section"><a href="#configuration-sso-process-idp-init">9.2.2. Identity provider initialized SSO</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-logout">9.3. Logout process</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-logout-local">9.3.1. Local logout</a></span></dt><dt><span class="section"><a href="#configuration-logout-global">9.3.2. Global logout</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-authentication-object">9.4. Authentication object</a></span></dt><dt><span class="section"><a href="#configuration-authentication-assertion">9.5. Authentication assertion</a></span></dt><dt><span class="section"><a href="#configuration-authentication-log">9.6. Authentication log</a></span></dt></dl></dd><dt><span class="chapter"><a href="#configuration-advanced">10. Advanced configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-load-balancing">10.1. Reverse proxies and load balancers</a></span></dt><dt><span class="section"><a href="#configuration-context-provider">10.2. Context provider</a></span></dt><dt><span class="section"><a href="#time-interval">10.3. Validity intervals</a></span></dt><dt><span class="section"><a href="#enhanced-client">10.4. Enhanced client/proxy</a></span></dt><dt><span class="section"><a href="#endpoint-url">10.5. Endpoint URLs</a></span></dt><dt><span class="section"><a href="#artifact-resolution">10.6. Artifact resolution</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#sample-app">III. Sample application</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-sample-app">11. Sample application</a></span></dt><dd><dl><dt><span class="section"><a href="#sample-authentication">11.1. SAML login</a></span></dt><dt><span class="section"><a href="#sample-administration-ui">11.2. Metadata administration</a></span></dt><dt><span class="section"><a href="#sample-administration-metadata-generation">11.3. Metadata generation</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#integration">IV. Integration guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-idp-guide">12. Integrating Identity Providers</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e1748">12.1. Active Directory Federation Services 2.0 (AD FS)</a></span></dt><dd><dl><dt><span class="section"><a href="#chapter-idp-guide-adfs-idp">12.1.1. Initialize IDP metadata</a></span></dt><dt><span class="section"><a href="#chapter-idp-guide-adfs-sp">12.1.2. Initialize SP metadata</a></span></dt><dt><span class="section"><a href="#chapter-idp-guide-adfs-test">12.1.3. Test SSO</a></span></dt></dl></dd><dt><span class="section"><a href="#d5e1816">12.2. Okta</a></span></dt><dd><dl><dt><span class="section"><a href="#chapter-idp-guide-okta-sp">12.2.1. Deploy Spring SAML sample application</a></span></dt><dt><span class="section"><a href="#chapter-idp-guide-okta-idp">12.2.2. Configure Okta</a></span></dt><dt><span class="section"><a href="#chapter-idp-guide-okta-spring-import">12.2.3. Import Okta metadata to Spring SAML</a></span></dt><dt><span class="section"><a href="#chapter-idp-guide-okta-test">12.2.4. Test SSO</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter-troubleshooting">13. Troubleshooting common problems</a></span></dt></dl></dd></dl></div>

	
	

	<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="getting-started" href="#getting-started"></a>Part&nbsp;I.&nbsp;Getting Started</h1></div></div></div>
		
		<div class="partintro"><div></div>
			<p>This chapter provides essential information needed to enable your application to act as
			a service provider and interact with identity providers using SAML 2.0 protocol. Later in this
			guide you can find information about detailed configuration options and additional use-cases
			enabled by this component.</p>
		</div>

		<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-introduction" href="#chapter-introduction"></a>1.&nbsp;Introduction</h2></div></div></div>
	

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-what-this-manual-covers" href="#section-what-this-manual-covers"></a>1.1&nbsp;What this manual covers</h2></div></div></div>
		

		<p>This manual describes Spring Security SAML Extension component, its uses, installation, configuration,
			design and integartion possibilities.
		</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-when-to-use" href="#section-when-to-use"></a>1.2&nbsp;When to use Spring Security SAML Extension</h2></div></div></div>
		

		<p>The extension enables both new and existing applications to act as a Service Provider in federations based on Web Single Sign-On
			and Single Logout profiles of SAML 2.0 protocol. The extension allows seamless combination of SAML 2.0 and other authentication and federation
			mechanisms in a single application. All products supporting SAML 2.0 in Identity Provider mode (e.g. ADFS, Okta, Shibboleth, OpenAM, Efecte EIM or Ping
			Federate) can be used with the extension.</p>
		<p>The extension can also be used in applications which are not primarily secured using Spring Security. It can be adapted
			for both single and multi-tenant environments. </p>
		<p>The extension can be either embedded inside your application and work along other authentication
			or single sign-on mechanisms, or it can be deployed separately and convey authentication information to
			applications using a custom mechanism.</p>
		<p>The extension is probably the most complete open-source SAML 2.0 SP implementation with the widest
			feature-set and configuration possibilities. Other Java open-source alternatives are e.g. native SAML service providers
			integrating with IIS or Apache from Shibboleth (SAML processing is done on the web server and not on the application
			level) or OpenAM Fedlet.</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-features-and-profiles" href="#section-features-and-profiles"></a>1.3&nbsp;Features and supported profiles</h2></div></div></div>
		

		<p>Current implementation should be conformant to SAML SP Lite and SAML eGovernment profile. The
			following profiles, bindings and features are supported as part of the product:
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Web single sign-on profile</p>
				</li><li class="listitem">
					<p>Web single sign-on holder-of-key profile</p>
				</li><li class="listitem">
					<p>IDP and SP initialized single sign-on</p>
				</li><li class="listitem">
					<p>Single logout profile</p>
				</li><li class="listitem">
					<p>Enhanced client/proxy profile</p>
				</li><li class="listitem">
					<p>Identity provider discovery profile and IDP selection</p>
				</li><li class="listitem">
					<p>Metadata interoperability and PKIX trust management</p>
				</li><li class="listitem">
					<p>Automatic service provider metadata generation</p>
				</li><li class="listitem">
					<p>Metadata loading from files, URLs, file-backed URLs</p>
				</li><li class="listitem">
					<p>Processing and automatic reloading of metadata with many identity providers</p>
				</li><li class="listitem">
					<p>Support for authentication contexts</p>
				</li><li class="listitem">
					<p>Logging for authentication events</p>
				</li><li class="listitem">
					<p>Customization of both SP and IDP metadata</p>
				</li><li class="listitem">
					<p>Processing of SAML attributes and user data using UserDetails interface</p>
				</li><li class="listitem">
					<p>Support for HTTP-POST, HTTP-Redirect, SOAP, PAOS and Artifact bindings</p>
				</li><li class="listitem">
					<p>Easy integration with applications using Spring Security</p>
				</li><li class="listitem">
					<p>Sample application with an user interface for quick configuration</p>
				</li></ul></div><p>
		</p>

		<p>You can use the following supported standards as a reference:</p>

			<p>SAML 2.0 basic profiles
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-authn-context-2.0-os.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-bindings-2.0-os.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/v2.0/saml-conformance-2.0-os.pdf</p>
				</li></ul></div>

			<p>SAML 2.0 additional profiles
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-holder-of-key-browser-sso.pdf
					</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-idp-discovery.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml2-holder-of-key.pdf</p>
				</li><li class="listitem">
					<p>http://docs.oasis-open.org/security/saml/Post2.0/sstc-metadata-iop.pdf</p>
				</li></ul></div>

			<p>eGovernment profile
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>
						http://kantarainitiative.org/confluence/download/attachments/42139782/kantara-egov-saml2-profile-2.0.pdf
					</p>
				</li></ul></div>

	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-requirements" href="#section-requirements"></a>1.4&nbsp;Requirements</h2></div></div></div>
		

		<p>Spring Security SAML Extension requires as a minimum Java 1.6 and is known to work with most Java containers and application servers. It can also be used
    with PaaS providers, such as Google App Engine, please see <a class="ulink" href="https://github.com/vschafer/spring-security-saml-gae" target="_top">https://github.com/vschafer/spring-security-saml-gae</a> for details.</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-source" href="#section-source"></a>1.5&nbsp;Source code</h2></div></div></div>
		

		<p>Source code for the project is maintained on <a class="ulink" href="https://github.com/SpringSource/spring-security-saml" target="_top">Github</a>.</p> 
	</div>
  
	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-build" href="#section-build"></a>1.6&nbsp;Builds</h2></div></div></div>
		

    <p>Snapshot builds of the project are available in the 
    <a class="ulink" href="http://repo.springsource.org/libs-snapshot/org/springframework/security/extensions/spring-security-saml/" target="_top">SpringSource repository</a>.
    We use <a class="ulink" href="https://build.springsource.org/browse/SES" target="_top">Bamboo</a> for continuous integration. 
    </p>     
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-license" href="#section-license"></a>1.7&nbsp;License</h2></div></div></div>
		

		<p>Source code of the module is licensed under the Apache License, Version 2.0. You may obtain copy
		of the license at <a class="ulink" href="http://www.apache.org/licenses/LICENSE-2.0" target="_top">http://www.apache.org/licenses/LICENSE-2.0</a>.</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-issue-tracking" href="#section-issue-tracking"></a>1.8&nbsp;Issue tracking</h2></div></div></div>
		

		<p>Please use <a class="ulink" href="https://jira.springsource.org/browse/SES/component/10711" target="_top">Spring Security Extensions Jira</a> for
			submitting of bugs and feature requests. Patches can be sent directly to GitHub as pull requests, but preferably open a Jira issue as well.</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-contributions" href="#section-contributions"></a>1.9&nbsp;Contributions</h2></div></div></div>
		

		<p>Please send your pull requests directly to GitHub and preferably also open issue in Jira.</p>
	</div>  

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-commercial-support" href="#section-commercial-support"></a>1.10&nbsp;Commercial support</h2></div></div></div>
		
	
<p>For commercial support and consulting services please contact <a class="ulink" href="vladimir@v7security.com" target="_top">sales@v7security.com</a></p>
	</div>
	
	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-support" href="#section-support"></a>1.11&nbsp;Community support</h2></div></div></div>
		

		<p>For community support please use <a class="ulink" href="http://stackoverflow.com/questions/tagged/spring-saml" target="_top">Stack Overflow</a>.
		The <a class="ulink" href="http://forum.springsource.org/forumdisplay.php?86-SAML" target="_top">Spring Security forums</a> contain some previously answered
		questions, but are now in read-only mode.</p>
	</div>

    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-dependencies" href="#section-dependencies"></a>1.12&nbsp;Dependencies</h2></div></div></div>
        
        <p>
            Internal processing of SAML messages, marshalling and unmarshalling is handled by <a class="ulink" href="https://wiki.shibboleth.net/confluence/display/OpenSAML/Home" target="_top">OpenSAML</a>.
        </p>
        <p>Spring SAML has a transitive dependency to library <a class="ulink" href="http://juliusdavies.ca/commons-ssl/" target="_top">not-yet-commons-ssl</a>.
            Inside Spring SAML this library is only used for hostname verifications and will be removed in case OpenSAML removes the dependency.</p>
    </div>

</div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-whats-new" href="#chapter-whats-new"></a>2.&nbsp;What's new</h2></div></div></div>
	
	<p>This section contains overview of important changes for released versions of Spring SAML.</p>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-whats-new-highlight-1.0.1" href="#section-whats-new-highlight-1.0.1"></a>2.1&nbsp;New features, improvements and fixes in 1.0.1.FINAL</h2></div></div></div>
      
    <p>Version 1.0.1.FINAL is fully backwards compatible with 1.0.0.FINAL and contains the following changes:</p>
    <p>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>Added support for Spring Security 4.0</p></li><li class="listitem"><p>Added integration guide with Okta</p></li><li class="listitem"><p>MaxAuthenticationAge time supports longer expiration times than 21 days</p></li><li class="listitem"><p>Deployment without JKS keystore is now supported</p></li><li class="listitem"><p>Service provider can now define multiple assertion consumer endpoints with same binding</p></li><li class="listitem"><p>Minor fixes and documentation improvements</p></li></ul></div><p>
    </p>
  </div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-whats-new-highlight-1.0.0" href="#section-whats-new-highlight-1.0.0"></a>2.2&nbsp;New features, improvements and fixes in 1.0.0.FINAL</h2></div></div></div>
		
    <p>Final release is not directly compatible with the previous RC versions, please make sure to migrate your code based on guidlines and changes below:</p>
    <p>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>Metadata signing now supports custom keyInfoGenerator and signingAlgorithm, signing can be enable per-entity</p></li><li class="listitem"><p>SAMLContextProvider has new customization possibilities for PKIXTrustEvaluator, PKIXInformationResolver and MetadataResolver</p></li><li class="listitem"><p>CertPathPKIXTrustEvaluator supports customization of security provider and explicit validation of certification path</p></li><li class="listitem"><p>MetadataCredentialResolver can be configured to load data from XML metadata and/or ExtendedMetadata</p></li><li class="listitem"><p>PKIXInformationResolver has an extension point for population of CRLs</p></li><li class="listitem"><p>Improvements to logging and error handling, profile implementations now throw exceptions which are logged inside filter objects and fail with ServletExceptions, sample application newly shows handling of these errors</p></li><li class="listitem"><p>Used OpenSAML version was updated to 2.6.1</p></li><li class="listitem"><p>SAMLDefaultLogger now logs additional information such as NameID</p></li><li class="listitem"><p>Enabled propagation of defaults (e.g. ProxySettings) set in the HttpClient object for ArtifactResolution</p></li><li class="listitem"><p>JKSKeyManager now supports keystores without password</p></li><li class="listitem"><p>SAMLContextProviderLB now supports empty contextPath and includes pathInfo data for requests</p></li><li class="listitem"><p>Entity ID and EntityDescriptor ID can now be set separately in MetadataGenerator</p></li><li class="listitem"><p>ECP now takes precedence over discovery in SAMLEntryPoint</p></li><li class="listitem"><p>Signing of local metadata is now done before displaying, this enables manual modifications to metadata in local files</p></li><li class="listitem"><p>ArtifactResolutionProfileImpl now support customization of used SocketFactory through extensions</p></li><li class="listitem"><p>ID in generated metadata is now automatically created when null, ID is based on entityID cleaned in order to conform to xsd:ID (and xsd:NCName) type, EntityID is cleaned by replacing all illegal characters by underscores</p></li><li class="listitem"><p>Support for hostname verification in artifact resolution</p></li><li class="listitem"><p>Completed documentation</p></li><li class="listitem"><p>Possibility to exclude the SAML Credential from the Authentication object</p></li><li class="listitem"><p>Disabled deferred node expansion for ParserPool which improves performance in parsing of small XML documents</p></li><li class="listitem"><p>HttpSessionStorage is now cleared after successful reception of a message in order to save memory</p></li><li class="listitem"><p>Possibility to include attributes from only the authenticated Assertion, or from all</p></li><li class="listitem"><p>New socket factory for trust verification during loading of metadata from HTTPS</p></li><li class="listitem"><p>Possibility to disable support for IDP-initialized SSO</p></li><li class="listitem"><p>Usage of metadata alias is now optional</p></li><li class="listitem"><p>New look and feel of the sample application</p></li><li class="listitem"><p>Cleanup of duplicate values in MetadataGenerator and ExtendedMetadata</p></li><li class="listitem"><p>SAMLCredential now contains facility methods for handling of String SAML attributes</p></li></ul></div><p>
		</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="section-whats-new-code-changes-1.0.0" href="#section-whats-new-code-changes-1.0.0"></a>2.3&nbsp;Important code changes in 1.0.0.FINAL</h2></div></div></div>
        
        <p>Below is an overview of major code and structure changes since Spring SAML 1.0 RC2 with possible effect on backwards compatibility.</p>

        <p><span class="emphasis"><em>Module names</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>module saml2-core was renamed to core, jar and maven artifact names stay the same</p></li><li class="listitem"><p>module saml2-sample was renamed to sample, jar and maven artifact names stay the same</p></li><li class="listitem"><p>module src was renamed to docs, jar and mave artifact names stay the same</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>Descriptor securityContext.xml</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>file saml2-sample/src/main/resources/security/securityContext.xml was moved to sample/src/main/webapp/WEB-INF/securityContext.xml</p></li><li class="listitem"><p>administration part of the UI is now secured with username/password</p></li><li class="listitem"><p>updated initialization of ParserPool to disable defer node expansion</p></li><li class="listitem"><p>HttpClient in ArtifactResolution was made thread safe</p></li><li class="listitem"><p>added new failure handler (failureRedirectHandler)</p></li><li class="listitem"><p>MetadataGenerator bean now demonstrates usage of ExtendedMetadata</p></li><li class="listitem"><p>FilesystemMetadataProvider was replaced with ResourceBackedMetadataProvider</p></li><li class="listitem"><p>file sample/src/main/resources/security/idp.xml was moved to sample/src/main/resources/metadata/idp.xml</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>ArtifactResolutionProfileBase</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>throws SAMLException instead of CredentialExpiredException on check of artifact response issue instant</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>HttpSessionStorage</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>storage is now cleared on successful message reception</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>MetadataDisplayFilter</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>new mandatory property KeyManager (autowired)</p></li></ul></div><p>
        </p>
       
        <p><span class="emphasis"><em>MetadataGenerator</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>generated metadata is no longer signed by default (enable in ExtendedMetadata.signMetadata) and has disabled IDP discovery (enable in ExtendedMetadata.includeDiscovery)</p></li><li class="listitem"><p>the following fields were moved from MetadataGenerator to ExtendedMetadata:
            </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>entityAlias -&gt; alias</p></li><li class="listitem"><p>signMetadata -&gt; signMetadata</p></li><li class="listitem"><p>signingKey -&gt; signingKey</p></li><li class="listitem"><p>encryptionKey -&gt; encryptionKey</p></li><li class="listitem"><p>tlsKey -&gt; tlsKey</p></li><li class="listitem"><p>includeDiscovery -&gt; idpDiscoveryEnabled</p></li><li class="listitem"><p>customDiscoveryURL -&gt; idpDiscoveryURL</p></li><li class="listitem"><p>customDiscoveryResponseURL -&gt; idpDiscoveryResponseURL</p></li></ul></div><p>
        </p></li><li class="listitem"><p>removed methods signSAMLObject (moved to SAMLUtil) and getKeyInfoGeneratorName (moved to ExtendedMetadata)</p></li><li class="listitem"><p>by default the first binding is now HTTP-POST instead of HTTP-Artifact, endpoint for Web SSO no longer includes PAOS binding, set property <span class="emphasis"><em>bindingsSSO</em></span> with values "artifact", "post", "paos" for backwards compatibility</p></li><li class="listitem"><p>by default endpoints for Web SSO holder of key are no longer included, set property <span class="emphasis"><em>bindingsHoKSSO</em></span> with values "artifact" and "post" for backwards compatibility</p></li><li class="listitem"><p>by default <span class="emphasis"><em>MetadataGeneratorFilter</em></span> no longer sets property <span class="emphasis"><em>entityAlias</em></span> to value <span class="emphasis"><em>defaultAlias</em></span>, set the value manually for backwards compatibility</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SAMLAuthenticationProvider</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>property forcePrincipalAsString is now set to true by default</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SAMLCredential</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>method getAttributeByName was renamed to getAttribute</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SAMLDiscovery</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>fails with ServletException instead of SAMLRuntimeException</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SAMLLogoutProcessingFilter</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>throws ServletException on errors during acceptance of LogoutRequest instead of SAMLRuntimeException</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SAMLUtil</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>removed unused getDefaultBinding method</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>SingleLogoutProfileImpl</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>sendLogoutResponse signature changed</p></li><li class="listitem"><p>changed error handling, throws SAMLStatusException which is handled by Filter, logged and sends a SAML Response</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>WebSSOProfileImpl</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>throws SAMLException instead of SAMLRuntimeException on missing data in context</p></li></ul></div><p>
        </p>

        <p><span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span>
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>new property includeAllAttributes, set to true for original behavior</p></li><li class="listitem"><p>throws SAMLException instead of CredentialExpiredException on check of resposne issue instant and assertion issue instant</p></li></ul></div><p>
        </p>
  
	</div>  

</div>

		<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="glossary" href="#glossary"></a>3.&nbsp;Glossary</h2></div></div></div>
	
	<p>
		</p><div class="table"><a name="glossary-table" href="#glossary-table"></a><p class="title"><b>Table&nbsp;3.1.&nbsp;Definitions of terms used within this manual</b></p><div class="table-contents">
			
			<table summary="Definitions of terms used within this manual" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Term</th><th style="border-bottom: 0.5pt solid ; " align="left">Definition</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Assertion</td><td style="border-bottom: 0.5pt solid ; " align="left">A part of SAML message (an XML document) which provides facts about subject of the assertion
							(typically about the authenticated user). Assertions can contain information about authentication,
							associated attributes or authorization decisions.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Artifact</td><td style="border-bottom: 0.5pt solid ; " align="left">Identifier which can be used to retrieve a complete SAML message from identity or service provider
							using a back-channel binding.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Binding</td><td style="border-bottom: 0.5pt solid ; " align="left">Mechanism used to deliver SAML message. Bindings are divided to front-channel bindings which
							use web-browser of the user for message delivery (e.g. HTTP-POST or HTTP-Redirect) and back-channel bindings
							where identity provider and service provider communicate directly (e.g. using SOAP calls in Artifact binding).</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Discovery</td><td style="border-bottom: 0.5pt solid ; " align="left">Mechanism used to determine which identity provider should be used to authenticate user currently
							interacting with the service provider.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Metadata</td><td style="border-bottom: 0.5pt solid ; " align="left">Document describing one or multiple identity and service providers. Metadata typically includes
							entity identifier, public keys, endpoint URLs, supported bindings and profiles, and other
							capabilities or requirements. Exchange of metadata between identity and service providers is
							typically the first step for establishment of federation.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Profile</td><td style="border-bottom: 0.5pt solid ; " align="left">Standardized combination of protocols, assertions, bindings and processing instructions used to
							achieve a particular use-case such as single sign-on, single logout, discovery, artifact resolution.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Protocol</td><td style="border-bottom: 0.5pt solid ; " align="left">Definition of format (schema) for SAML messages used to achieve particular functionality such as
							requesting authentication from IDP, performing single logout or requesting attributes from IDP.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Identity provider (IDP)</td><td style="border-bottom: 0.5pt solid ; " align="left">Entity which knows how to authenticate users and provides information
						about their identity to service providers/relaying parties using federation protocols.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Service provider (SP)</td><td style="border-bottom: 0.5pt solid ; " align="left">Your application which communicates with the identity provider in order to obtain information
							about the user it interacts with. User information such as authentication state and user attributes
							is provided in form of security assertions.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Single Sign-On (SSO)</td><td style="border-bottom: 0.5pt solid ; " align="left">Process enabling access to multiple web sites without need to repeatedly present credentials necessary
						for authentication. Various federation protocols such as SAML, WS-Federation, OpenID or OAuth can be used to achieve
						SSO use-cases. Information such as means of authentication, user attributes, authorization decisions or security tokens are
						typically provided to the service provider as part of single sign-on.</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Single Logout (SLO)</td><td style="" align="left">Process terminating authenticated sessions at all resources which were accessed using single sign-on. Techniques
						such as redirecting user to each of the SSO participants or sending a logout SOAP messages are typically used.</td></tr></tbody></table>
		</div></div><p><br class="table-break">

	</p>
</div>

		<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-quick-start" href="#chapter-quick-start"></a>4.&nbsp;Quick start guide</h2></div></div></div>
	
	<p>
		This chapter will guide you through steps required to easily integrate Spring Security SAML Extension with
		ssocircle.com's IDP service using SAML 2.0 protocol.
		When done you will have a working example of Web SSO against a single Identity Provider. The steps will
		guide you through deployment of the <a class="link" href="#chapter-sample-app" title="11.&nbsp;Sample application">sample application</a>,
		configuration of IDP metadata (XML document describing how to connect to the IDP server using SAML 2.0
		protocol) and SP metadata (XML document describing
		your own service) and testing of web single sign-on and single logout.
	</p>
  <p>Public demo of the sample application is available at <a class="ulink" href="https://saml-federation.appspot.com" target="_top">saml-federation.appspot.com</a></p>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quick-start-prerequisites" href="#quick-start-prerequisites"></a>4.1&nbsp;Pre-requisites</h2></div></div></div>
		

		<p>Please make sure the following items are available before starting the installation:
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Java 1.6+ SDK</p>
				</li><li class="listitem">
					<p>Apache Maven</p>
				</li></ul></div><p>
		</p>
		<p>SAML Extension relies on XML processing capabilities of JAXP. Some older versions of JRE might require updating of the embedded
		JAXP libraries. In case you encounter XML processing exceptions please create folder <span class="emphasis"><em>jdk/jre/lib/endorsed</em></span> in your
		JDK installation and include files in <span class="emphasis"><em>lib/endorsed</em></span> from the latest OpenSAML archive available at
		<a class="ulink" href="http://shibboleth.net/downloads/java-opensaml/" target="_top">http://shibboleth.net/downloads/java-opensaml/</a>. The location of the
		endorsed folder may differ based on your application server or container.</p>
		<p>Due to US export limitations Java JDK comes with a limited set of cryptography capabilities. Usage of the SAML Extension might require 
		installation of the <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_top">Unlimited Strength Jurisdiction 
		Policy Files</a> which removes these limitations.</p>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quick-start-steps" href="#quick-start-steps"></a>4.2&nbsp;Installation steps</h2></div></div></div>
		

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-download" href="#quick-start-download"></a>4.2.1&nbsp;Downloading sample application</h3></div></div></div>
		
		<p>Download the Spring SAML Extension either from <a class="ulink" href="https://github.com/SpringSource/spring-security-saml" target="_top">sources</a> or
		from one of the <a class="ulink" href="http://repo.spring.io/list/release/org/springframework/security/extensions/spring-security-saml/" target="_top">releases</a>.</p>
		<p>The Spring SAML Sample application is included in <span class="emphasis"><em>sample</em></span> directory. We will be customizing
		content of the sample application in the following steps.</p>
	</div> 

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-idp-metadata" href="#quick-start-idp-metadata"></a>4.2.2&nbsp;Configuration of IDP metadata</h3></div></div></div>
			
			<p>Modify file
				<span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span>
				of the sample application and replace <span class="emphasis"><em>metadata</em></span> bean as follows:
				</p><pre class="programlisting">&lt;bean id="metadata" class="org.springframework.security.saml.metadata.CachingMetadataManager"&gt;
	&lt;constructor-arg&gt;
		&lt;list&gt;
			&lt;bean class="org.opensaml.saml2.metadata.provider.HTTPMetadataProvider"&gt;
				&lt;constructor-arg&gt;
					&lt;value type="java.lang.String"&gt;http://idp.ssocircle.com/idp-meta.xml&lt;/value&gt;
				&lt;/constructor-arg&gt;
				&lt;constructor-arg&gt;
					&lt;value type="int"&gt;5000&lt;/value&gt;
				&lt;/constructor-arg&gt;
				&lt;property name="parserPool" ref="parserPool"/&gt;
			&lt;/bean&gt;
		&lt;/list&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre><p>
			</p>
			<p>The settings tell system to download IDP metadata from the given URL with timeout of 5
				seconds. In production system metadata should be either stored as a local file or be downloaded
				from a source using SSL/TLS with configured trust or which provides digitally signed metadata.
			</p>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-sp-metadata" href="#quick-start-sp-metadata"></a>4.2.3&nbsp;Generation of SP metadata</h3></div></div></div>
			
			<p>Modify file
				<span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span>
				of the sample application, replace <span class="emphasis"><em>metadataGeneratorFilter</em></span> bean as follows and make sure to replace
				the entityId value with a string which is unique within the SSO Circle service (e.g. urn:test:yourname:yourcity):
				</p><pre class="programlisting">&lt;bean id="metadataGeneratorFilter" class="org.springframework.security.saml.metadata.MetadataGeneratorFilter"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
			&lt;property name="entityId" value="replaceWithUniqueIdentifier"/&gt;
			&lt;property name="extendedMetadata"&gt;
				&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"&gt;
					&lt;property name="signMetadata" value="false"/&gt;
					&lt;property name="idpDiscoveryEnabled" value="true"/&gt;
				&lt;/bean&gt;
			&lt;/property&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre><p>
			</p>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-compilation" href="#quick-start-compilation"></a>4.2.4&nbsp;Compilation</h3></div></div></div>
			
			<p>
				When building from sources compile whole project and install artifacts into your local Maven repository using:
				</p><pre class="programlisting">gradlew build install</pre><p>
			</p>
			<p>
				When using the release zip compile the sample application available in the <span class="emphasis"><em>sample</em></span> directory using:
				</p><pre class="programlisting">mvn package</pre><p>
			</p>
			<p>
				You can find the compiled war archive <span class="emphasis"><em>spring-security-saml2-sample.war</em></span> in directory
				<span class="emphasis"><em>sample/build/libs/</em></span> (gradle) or <span class="emphasis"><em>sample/target/</em></span> (maven).
			</p>
			<p>
				Project files for your IDE can be created with <span class="emphasis"><em>gradlew eclipse</em></span> or <span class="emphasis"><em>gradlew idea</em></span>.
			</p>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-deploy" href="#quick-start-deploy"></a>4.2.5&nbsp;Deployment</h3></div></div></div>
			
			<p>You can start the application from the release <span class="emphasis"><em>sample</em></span> directory using command: </p><pre class="programlisting">mvn tomcat7:run</pre>
			<p>Same can be achieved using gradle with: </p><pre class="programlisting">gradlew tomcatRun</pre>
			<p>After startup the Spring SAML sample application will be available at <span class="emphasis"><em>http://localhost:8080/spring-security-saml2-sample</em></span></p>
			<p>Alternatively you can deploy the war archive to your application server or container.</p>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="quick-start-sp-metadata-to-idp" href="#quick-start-sp-metadata-to-idp"></a>4.2.6&nbsp;Uploading of SP metadata to the IDP</h3></div></div></div>
			
			<p>Download current SP metadata: </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Open web browser to the URL of the deployed application.</p>
				</li><li class="listitem">
					<p>Select <span class="emphasis"><em>Metadata information</em></span>.</p>
				</li><li class="listitem">
					<p>Select first item from category <span class="emphasis"><em>Service providers</em></span>, e.g.
						<span class="emphasis"><em>
							http://localhost:8080/spring-security-saml2-sample/saml/metadata
						</em></span>
					</p>
				</li><li class="listitem">
					<p>Copy content of the Metadata textarea to your clipboard.</p>
				</li></ul></div>
			<p>Upload SP metadata to the IDP: </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Register yourself at www.ssocircle.com and login to the service.</p>
				</li><li class="listitem">
					<p>Select Metadata manager and click Add new Service Provider.</p>
				</li><li class="listitem">
					<p>Enter <span class="emphasis"><em>entityId</em></span> configured in <a class="xref" href="#quick-start-sp-metadata" title="4.2.3&nbsp;Generation of SP metadata">Section&nbsp;4.2.3, &#8220;Generation of SP metadata&#8221;</a> in the FQDN field.</p>
				</li><li class="listitem">
					<p>Paste content of clipboard into the metadata information textarea.</p>
				</li><li class="listitem">
					<p>Store metadata by pressing the Submit button.</p>
				</li><li class="listitem">
					<p>Logout from the SSOCircle service.</p>
				</li></ul></div>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="quick-start-testing" href="#quick-start-testing"></a>4.3&nbsp;Testing single sign-on and single logout</h2></div></div></div>
		
		<p>Open the front page of your SP application, select <span class="emphasis"><em>http://idp.ssocircle.com</em></span> IDP and press login. The system
		will generate a new authentication request using SAML 2.0 protocol, digitally sign it and send it to the IDP. After authentication at IDP
		with your account you will be redirected back to your application and automatically signed-in.</p>
		<p>Pressing local logout will destroy local session and logout the user. While a session is still active at the IDP an attempt to reauthenticate
		will proceed without need to enter credentials.</p>
		<p>Pressing global logout will destroy both local session and the session at IDP.</p>
		<p>You can test IDP initialized single sign-on with URL <span class="emphasis"><em>https://idp.ssocircle.com:443/sso/saml2/jsp/idpSSOInit.jsp?metaAlias=/ssocircle&amp;spEntityID=replaceWithUniqueIdentifier</em></span>, after replacing
		the service provider identifier with the one configured as entityId in your securityContext.xml. It is possible to provide relayState data sent to your SP with parameter <span class="emphasis"><em>RelayState</em></span>.</p>
	</div>
</div>
	</div>

	<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="configuration" href="#configuration"></a>Part&nbsp;II.&nbsp;Configuring SAML Extension</h1></div></div></div>	
  
		
		<div class="partintro"><div></div>
			<p>This chapter provides information about configuration and customization options of the SAML extension.
			It will guide you through typical scenarios including problems you might encounter during integration with
			identity providers.</p>
		</div>
    
	<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="configuration-overview" href="#configuration-overview"></a>5.&nbsp;Overview</h2></div></div></div>
		
		<p>Spring Security SAML 2.0 library comprises three modules:
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>
						<span class="emphasis"><em>core</em></span>
						contains implementation of the WebSSO profiles of the SAML 2.0 protocol and is required for
						integration to target systems.
					</p>
				</li><li class="listitem">
					<p>
						<span class="emphasis"><em>sample</em></span>
						contains example of Spring configuration used for integration to target systems. It also
						contains user interface for generation and management of metadata.
					</p>
				</li><li class="listitem">
					<p>
						<span class="emphasis"><em>docs</em></span>
						contains this documentation.
					</p>
				</li></ul></div><p>
		</p>
		<p>Configuration of the library is done using Spring context XML. An example of configuration can be found
			under <span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span>.
			Setting up of the library typically involves these steps:
			</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p><a class="link" href="#configuration-integration" title="6.&nbsp;Integration to applications">integration to application using Spring XML configuration</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-metadata" title="7.&nbsp;Metadata configuration">import, generation and customization of SP and IDP metadata</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-key-management" title="8.1&nbsp;Key management">configuration of signature, encryption and trust keys</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-security-profiles" title="8.2&nbsp;Security profiles">configuration of security profiles</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-load-balancing" title="10.1&nbsp;Reverse proxies and load balancers">configuration of reverse proxy or load balancer</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-discovery" title="9.1&nbsp;IDP selection and discovery">configuration of IDP selection or discovery</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-sso" title="9.&nbsp;Single sign-on configuration">configuration of single sign-on process</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-logout" title="9.3&nbsp;Logout process">configuration of logout process</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-authentication-object" title="9.4&nbsp;Authentication object">configuration of authentication object</a></p>
				</li><li class="listitem">
					<p><a class="link" href="#configuration-authentication-log" title="9.6&nbsp;Authentication log">configuration of authentication log</a></p>
				</li></ul></div><p>
		</p>
		<p>Additional steps such as customization of SAML 2.0 bindings, configuration of artifact resolution 
 or configuration of time skews might be needed.
		</p>
	</div>

	<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="configuration-integration" href="#configuration-integration"></a>6.&nbsp;Integration to applications</h2></div></div></div>
		
		<p>SAML module can be directly embedded into new or existing Spring applications. In
			this case application itself includes the SAML library in WEB-INF/lib directory of the war archive and
			processes all SAML interactions. The other option of using the SAML library is deploying it as a
			stand-alone module
			which transfers information about the authenticated user to the target application using a custom
			mechanism. This chapter only discusses the first option.
		</p>
		<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-integration-maven" href="#configuration-integration-maven"></a>6.1&nbsp;Maven dependency</h2></div></div></div>
			
			<p>
				In order to include the library and all its dependencies add the following dependency to your
				pom.xml file:
				</p><pre class="programlisting">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.security.extensions&lt;/groupId&gt;
	&lt;artifactId&gt;spring-security-saml2-core&lt;/artifactId&gt;
	&lt;version&gt;${version}&lt;/version&gt;
&lt;/dependency&gt;</pre><p>
			</p>
			<p>The current version of SAML Extension has been tested to work with Spring 3.1.2, Spring Security 3.1.2 and OpenSAML 2.6.1.
			Later versions of these libraries are likely to be compatible without need for modifications.</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-integration-bean-definitions" href="#configuration-integration-bean-definitions"></a>6.2&nbsp;Bean definitions</h2></div></div></div>
			
			<p>Configuration of the SAML library requires beans definitions included in the
				<span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span>
				configuration file. Include copy of the file in your own Spring application, either directly or with
				an inclusion. Configuration steps in the following chapters will be customizing beans included in
				the default context.
			</p>
			<p>Beans of the SAML library are using auto-wiring and annotation-based configuration by default.
				Make sure that your Spring configuration
				contains e.g. the following settings in order to enable support for these features:
				</p><pre class="programlisting">&lt;context:annotation-config/&gt;
&lt;context:component-scan base-package="org.springframework.security.saml"/&gt;
</pre><p>
				</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-java" href="#configuration-java"></a>6.3&nbsp;Java-based configuration</h2></div></div></div>
			
				<p>Spring SAML will include configuration classes for Spring Java-based configuration in future versions.</p>
				<p>For an example of <span class="emphasis"><em>securityContext.xml</em></span> translated into Java configuration in a Spring Boot application see project by Vincenzo De Notaris at <a class="ulink" href="https://github.com/vdenotaris/spring-boot-security-saml-sample" target="_top">https://github.com/vdenotaris/spring-boot-security-saml-sample</a>.</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-integration-spring-security" href="#configuration-integration-spring-security"></a>6.4&nbsp;Spring Security integration</h2></div></div></div>
				
				<p>Filters of the SAML module need to be enabled as part of the Spring Security settings. In case
					SAML authentication should be the default authentication mechanism of the application set bean
					<span class="emphasis"><em>samlEntryPoint</em></span>
					as the default entry point. Make sure that filter
					<span class="emphasis"><em>samlFilter</em></span>
					is included as one of the custom filters. In case SP metadata should be
					generated automatically during first request to the application include also filter<span class="emphasis"><em>
						metadataGeneratorFilter</em></span>.
					The configuration directive may for example look as follows:
					</p><pre class="programlisting">&lt;security:http entry-point-ref="samlEntryPoint"&gt;
	&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;
	&lt;security:custom-filter after="BASIC_AUTH_FILTER" ref="samlFilter"/&gt;
&lt;/security:http&gt;</pre><p>
			</p>
		</div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="error-handling" href="#error-handling"></a>6.5&nbsp;Error handling</h2></div></div></div>
            
            <p>Critical errors raised during processing of SAML messages are generally propagated as ServletExceptions to the Java container. In order to configure a custom error handling update your web.xml
                and provide a general handler for ServletExceptions:</p><pre class="programlisting">&lt;error-page&gt;
	&lt;exception-type&gt;javax.servlet.ServletException&lt;/exception-type&gt;
	&lt;location&gt;/error.jsp&lt;/location&gt;
&lt;/error-page&gt;</pre>
            <p>ServletException contains original reason for the failure as a cause. It is recommended that content of the exceptions is not displayed to end users, both for security and user experience reasons.</p>
            <p>Errors produced during processing of the SAML AuthenticationResponse can be handled by plugging a custom implementation of
                the <span class="emphasis"><em>org.springframework.security.web.authentication.AuthenticationFailureHandler</em></span> interface to the <span class="emphasis"><em>samlWebSSOProcessingFilter</em></span> bean.</p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="logging" href="#logging"></a>6.6&nbsp;Logging</h2></div></div></div>
            
            <p>SAML Extension uses <a class="ulink" href="http://www.slf4j.org/" target="_top">SLF4J framework</a> for logging. The same applies to the underlaying OpenSAML
                library. The sample application by default uses log4j version 1.2 binding for SLF4J, configured with the following dependency:</p><pre class="programlisting">&lt;dependency&gt;
	&lt;groupId&gt;org.slf4j&lt;/groupId&gt;
	&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
	&lt;version&gt;1.6.3&lt;/version&gt;
	&lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;</pre>
            <p>In case you are using another logging library, make sure to change the dependency accordingly.</p>
            <p>You can enable debug logging by modifying file <span class="emphasis"><em>sample/src/main/resources/log4j.properties</em></span> and adding:
                </p><pre class="programlisting">log4j.logger.org.springframework.security.saml=DEBUG
log4j.logger.org.opensaml=DEBUG
log4j.logger.PROTOCOL_MESSAGE=DEBUG</pre>
            <p>For details about using other logging frameworks please consult the <a class="ulink" href="http://www.slf4j.org/manual.html" target="_top">SLF4J manual</a>.</p>
        </div>
	</div>

	<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="configuration-metadata" href="#configuration-metadata"></a>7.&nbsp;Metadata configuration</h2></div></div></div>
		
		<p>
			SAML metadata is an XML document which contains information necessary for interaction with SAML-enabled identity
			or service providers. The document contains e.g. URLs of endpoints, information about supported bindings, identifiers and
			public keys. Typically one metadata document will be generated for your own service provider and sent to all identity providers
			you want to enable single sign-on with. Similarly, each identity provider will make its own metadata available for you to import
			into your service provider application.
		</p>
		<p>
			Each metadata document can contain definition for one or many identity or service providers and optionally can be digitally signed.
			Metadata can be customized either by direct modifications to the XML document, or using extended metadata. Extended metadata is added
			directly to the Spring configuration file and can contain additional options which are unavailable in the basic metadata document.
		</p>
		<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-metadata-sp" href="#configuration-metadata-sp"></a>7.1&nbsp;Service provider metadata</h2></div></div></div>
			
			<p>Service provider metadata contains keys, services and URLs defining SAML endpoints of your application. Metadata can be either
			generated automatically upon first request to the service, or it can be pre-created (see <a class="xref" href="#chapter-sample-app" title="11.&nbsp;Sample application">Chapter&nbsp;11, <i>Sample application</i></a>).
			Once created metadata needs to be provided to the identity providers with whom we want to establish trust.</p>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-sp-generation" href="#configuration-metadata-sp-generation"></a>7.1.1&nbsp;Automatic metadata generation</h3></div></div></div>
				
				<p>
					Automatic metadata generation is enabled by including the following filter in the Spring Security configuration:
					</p><pre class="programlisting">&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;</pre><p>
				</p>
				<p>
					This filter is automatically invoked as part of the first request to a URL processed by Spring Security. In case there
					is no service provider metadata already specified (meaning property <span class="emphasis"><em>hostedSPName</em></span> of the
					<span class="emphasis"><em>metadata</em></span> bean is empty) filter will generate a new one.
				</p>
				<p>
					By default metadata will be generated with the following values which can be customized by setting properties of the <span class="emphasis"><em>metadataGenerator</em></span> bean:
					</p><div class="table"><a name="configuration-metadata-sp-generation-default-values" href="#configuration-metadata-sp-generation-default-values"></a><p class="title"><b>Table&nbsp;7.1.&nbsp;Metadata generator settings</b></p><div class="table-contents">
						
						<table summary="Metadata generator settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"><col align="left" class="_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description</th><th style="border-bottom: 0.5pt solid ; " align="left">Default value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">entityBaseURL</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Base URL to construct SAML endpoints from, needs to be a URL with protocol, server, port and context path.</td><td style="border-bottom: 0.5pt solid ; " align="left">Values from the request in format: <span class="emphasis"><em>scheme://server:port/contextPath</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">entityId</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Unique identifier of the service provider.</td><td style="border-bottom: 0.5pt solid ; " align="left">&lt;entityBaseUrl&gt;/saml/metadata</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">id</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">XML identifier of the root metadata element referred in signature.</td><td style="border-bottom: 0.5pt solid ; " align="left">entityId with removed illegal characters (NCName)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">requestSigned</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Flag indicating whether this service signs authentication requests.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">wantAssertionSigned</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Flag indicating whether this service requires signed assertions.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsSSO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for WebSSO profile. Supported values are: POST, Artifact and PAOS. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">POST, Artifact</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsHoKSSO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for WebSSO Holder-of-Key profile. Supported values are: POST and Artifact. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsSLO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for Single Logout profile. Supported values are: POST and Redirect. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">POST, Redirect</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">assertionConsumerIndex</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Index of assertion consumer point to be marked as default.</td><td style="border-bottom: 0.5pt solid ; " align="left">0</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">includeDiscoveryExtension</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When true generated metadata will contain extension indicating that it's able to consume response from an IDP Discovery service.</td><td style="border-bottom: 0.5pt solid ; " align="left">false</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">nameID</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Name identifiers to be included in the metadata. Supported values are: EMAIL, TRANSIENT, PERSISTENT, UNSPECIFIED and X509_SUBJECT. Order of NameIDs in the property determines order of NameIDs in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">EMAIL, TRANSIENT, PERSISTENT, UNSPECIFIED, X509_SUBJECT</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left"><code class="literal">extendedMetadata</code></td><td style="border-right: 0.5pt solid ; " align="left">Additional settings such as security keys, entity alias, metadata signing, IDP discovery, ECP settings, security profiles and signature requirements can be specified in the ExtendedMetadata, see <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a> for details.</td><td style="" align="left">no extended metadata</td></tr></tbody></table>
					</div></div><p><br class="table-break">
				</p>
				<p>
					In case property <code class="literal">entityBaseURL</code> is not specified, it will be automatically generated based on values in the first HTTP request.
					Generated value can be normalized to exclude standard 80/443 ports for http/https schemes by setting property <code class="literal">normalizeBaseUrl</code> of the MetadataGeneratorFilter
					to <code class="literal">true</code>. It is recommended to provide the value explicitly in the configuration.
				</p>
				<p>
					Providing an empty collection or null value to properties <span class="emphasis"><em>bindingsSSO</em></span>, <span class="emphasis"><em>bindingsHoKSSO</em></span> and <span class="emphasis"><em>bindingsSLO</em></span>
					will disable and remove the given profile. For example the following setting removes the holder-of-key profile from the generated metadata,
					forces artifact binding for single sign-on and redirect binding for single logout: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
	&lt;property name="bindingsSSO"&gt;&lt;list&gt;&lt;value&gt;artifact&lt;/value&gt;&lt;/list&gt;&lt;/property&gt;
	&lt;property name="bindingsSLO"&gt;&lt;list&gt;&lt;value&gt;redirect&lt;/value&gt;&lt;/list&gt;&lt;/property&gt;
	&lt;property name="bindingsHoKSSO"&gt;&lt;list/&gt;&lt;/property&gt;
&lt;/bean&gt;</pre>
				<p>
					By default generated metadata will not be digitally signed. Digital signature can be enabled using property
					<code class="literal">signMetadata</code> of the <span class="emphasis"><em>extendedMetdata</em></span> bean.
				</p>
				<p>
					In case application is deployed behind a reverse-proxy or other mechanism which makes the URL at the application server different
					from the URL seen by client at least property <code class="literal">entityBaseURL</code> should be set to a value e.g. https://www.server.com:8080
					For details about load balancing see <a class="xref" href="#configuration-load-balancing" title="10.1&nbsp;Reverse proxies and load balancers">Section&nbsp;10.1, &#8220;Reverse proxies and load balancers&#8221;</a>.
				</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-sp-import" href="#configuration-metadata-sp-import"></a>7.1.2&nbsp;Pre-configured metadata</h3></div></div></div>
				
				<p>In some situations it is beneficial to provide static version of the metadata document instead of the automatic generation. Need
				for manual changes in the metadata or fixing of production settings are some of those. A custom metadata document describing local SP application
				can be added by updating the <span class="emphasis"><em>metadata</em></span> bean with correct ExtendedMetadata. Please follow these steps
				in order to do so: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
					  <p>Generate and download metadata, e.g. using the <span class="emphasis"><em>Metadata Administration -&gt; Generate new service provider metadata</em></span> option in the sample application's administration UI or using instructions in <a class="link" href="#configuration-metadata-sp-generation" title="7.1.1&nbsp;Automatic metadata generation">automatic metadata generator</a>.</p>
				  </li><li class="listitem">
					  <p>Store the metadata file as part of your project classpath, e.g. in <span class="emphasis"><em>WEB-INF/classes/metadata/localhost_sp.xml</em></span>.</p>
				  </li><li class="listitem">
					  <p>Disable the automatic metadata generator by removing the following custom filter from the <span class="emphasis"><em>securityContext.xml</em></span>: </p><pre class="programlisting">&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;</pre>
				  </li><li class="listitem">
					  <p>Include the SP metadata in the <span class="emphasis"><em>metadata</em></span> bean and mark the entity as <span class="emphasis"><em>local</em></span> in the extended metadata. Make sure to specify the <span class="emphasis"><em>alias</em></span>
					  property in case it was used during metadata generation.</p>
					  <p>It is recommended to use the administration UI which also generates all the Spring declarations ready for inclusion in your <span class="emphasis"><em>securityContext.xml</em></span>.</p>
					  <p>Configuration for pre-configured local metdadata can look for example like this: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.ResourceBackedMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;bean class="java.util.Timer"/&gt;
			&lt;/constructor-arg&gt;
			&lt;constructor-arg&gt;
				&lt;bean class="org.opensaml.util.resource.ClasspathResource"&gt;
					&lt;constructor-arg value="/metadata/localhost_sp.xml"/&gt;
				&lt;/bean&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"&gt;
			&lt;property name="local" value="true"/&gt;
			&lt;property name="securityProfile" value="metaiop"/&gt;
			&lt;property name="sslSecurityProfile" value="pkix"/&gt;
			&lt;property name="signMetadata" value="true"/&gt;
			&lt;property name="signingKey" value="apollo"/&gt;
			&lt;property name="encryptionKey" value="apollo"/&gt;
			&lt;property name="requireArtifactResolveSigned" value="false"/&gt;
			&lt;property name="requireLogoutRequestSigned" value="false"/&gt;
			&lt;property name="requireLogoutResponseSigned" value="false"/&gt;
			&lt;property name="idpDiscoveryEnabled" value="true"/&gt;
			&lt;property name="idpDiscoveryURL"
				value="https://www.server.com:8080/context/saml/discovery"/&gt;
			&lt;property name="idpDiscoveryResponseURL"
				value="https://www.server.com:8080/context/saml/login?disco=true"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
				  </li></ul></div>
				<p>Same instance of your application can include multiple statically declared local service providers each differentiated by its own unique
				alias and entity ID, see <a class="xref" href="#configuration-entity-alias" title="7.4&nbsp;Multi-tenancy and entity alias">Section&nbsp;7.4, &#8220;Multi-tenancy and entity alias&#8221;</a> for details. In case your application defines multiple local service providers,
				set property <span class="emphasis"><em>hostedSPName</em></span> of the <span class="emphasis"><em>metadata</em></span> bean to the entity ID of the default one.</p>
				<p>The file with pre-configured metadata doesn't need to include digital signature. Metadata will be automatically signed during runtime when property <span class="emphasis"><em>signMetadata</em></span> is set to <span class="emphasis"><em>true</em></span>.</p>
				<p>For details about available settings of the ExtendedMetadata see <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a>.</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-sp-display" href="#configuration-metadata-sp-display"></a>7.1.3&nbsp;Downloading metadata</h3></div></div></div>
				
				<p>Metadata describing the default local application can be downloaded from URL: </p><pre class="programlisting">https://www.server.com:8080/context/saml/metadata</pre>
				<p>In case the application is configured to contain multiple service providers metadata for each can be loaded by
				adding the alias: </p><pre class="programlisting">https://www.server.com:8080/context/saml/login/alias/defaultAlias</pre>
				<p>URL for metadata download can be disabled by removing filter <span class="emphasis"><em>metadataDisplayFilter</em></span> from the <span class="emphasis"><em>securityContext.xml</em></span>.</p>
				<p>Metadata is also available in the sample application's administration UI under <span class="emphasis"><em>Metadata information -&gt; selected SP</em></span>.</p>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-metadata-idp" href="#configuration-metadata-idp"></a>7.2&nbsp;Identity provider metadata</h2></div></div></div>
			
			<p>Metadata for identity providers is imported to the <span class="emphasis"><em>metadataManager</em></span> in a similar way as pre-configured
			SP metadata. Metadata containing one or many identity providers can be added by providing an URL or a file. Processing of metadata and
			processing of SAML messages can be customized using properties of ExtendedMetadataDelegate and ExtendedMetadata.</p>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-idp-file" href="#configuration-metadata-idp-file"></a>7.2.1&nbsp;File-based metadata provider</h3></div></div></div>
				
				<p>File-based provider loads metadata from a file available in the filesystem or classpath.</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.FilesystemMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.io.File"&gt;classpath:security/idp.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
			  <p>Metadata is automatically refreshed in intervals specified by properties <span class="emphasis"><em>minRefreshDelay</em></span> and <span class="emphasis"><em>maxRefreshDelay</em></span> of the <span class="emphasis"><em>MetadataProvider</em></span> bean.</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-idp-http" href="#configuration-metadata-idp-http"></a>7.2.2&nbsp;HTTP-based metadata provider</h3></div></div></div>
				
				<p>HTTP-based provider loads metadata from an URL.</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.HTTPMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.lang.String"&gt;http://idp.ssocircle.com/idp-meta.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;constructor-arg&gt;
				&lt;!-- Timeout for metadata loading in ms --&gt;
				&lt;value type="int"&gt;5000&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
				<p>Metadata is automatically refreshed in intervals specified by properties <span class="emphasis"><em>minRefreshDelay</em></span> and <span class="emphasis"><em>maxRefreshDelay</em></span> of the <span class="emphasis"><em>MetadataProvider</em></span> bean.</p>
				<p>Alternatively class <span class="emphasis"><em>org.opensaml.saml2.metadata.provider.FileBackedHTTPMetadataProvider</em></span> can be used to provide a backup in case URL is temporarily unavailable. File
				to use as backup is specified as third argument in the <span class="emphasis"><em>MetadataProvider</em></span> bean constructor.</p>
			</div>
            <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-https" href="#configuration-metadata-https"></a>7.2.3&nbsp;HTTP-based metadata provider with SSL</h3></div></div></div>
                
                <p>By default, loading of metadata using the HTTP-based provider over HTTPS performs trust verification configured in your JDK. In case you'd like to use certificates in your <span class="emphasis"><em>keyStore</em></span>, add the following bean which changes the socketFactory used by the HTTP Client:
                </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.trust.httpclient.TLSProtocolConfigurer"/&gt;</pre>
                <p>The <span class="emphasis"><em>TLSProtocolConfigurer</em></span> instantiates <span class="emphasis"><em>TLSProtocolSocketFactory</em></span> and registers is as a default socket factory for https protocol inside the HTTP Client used for metadata loading.
                The socket factory uses all public certificates present in the <span class="emphasis"><em>keyStore</em></span> as trust anchors for PKIX validation. The used keys can be constrained with property <span class="emphasis"><em>trustedKeys</em></span>.</p>
                <p>The socket factory configured in this fashion is used for all metadata providers. It is possible to customize metadata loading on a per-provider basis by adding a configured HttpClient instance to the HTTPMetadataProvider constructor.</p>
            </div>
			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-idp-signature" href="#configuration-metadata-idp-signature"></a>7.2.4&nbsp;Metadata signature verification</h3></div></div></div>
				
				<p>Importing of digitally signed metadata requires verification of signature's validity and trust. Metadata is not required to be signed by default.
				When present, signature is verified with PKIX algorithm and uses all public keys present in the configured <span class="emphasis"><em>keyManager</em></span> as trust anchors. Make sure to include root CA
				certificate and intermediary CA certificates of the signature in your <span class="emphasis"><em>keyStore</em></span>. For details see <a class="xref" href="#configuration-key-management-public-keys" title="8.1.3&nbsp;Importing public keys">Section&nbsp;8.1.3, &#8220;Importing public keys&#8221;</a>.</p>
				<p>You can limit certificates used to peform the verification by setting property <span class="emphasis"><em>metadataTrustedKeys</em></span> of the ExtendedMetadataDelegate bean. The provided
				collection should contain aliases of keys to be used as trust anchors.</p>
				<p>Signature verification can be disabled by setting property <span class="emphasis"><em>metadataTrustCheck</em></span> to false in the ExtendedMetadataDelegate bean.
				Setting <span class="emphasis"><em>metadataRequireSignature</em></span> to true will reject metadata unless it's digitally signed.</p>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-metadata-extended" href="#configuration-metadata-extended"></a>7.3&nbsp;Extended metadata</h2></div></div></div>
			
			<p>Extended metadata provides additional settings for customization of SAML exchanges between SP and IDP which are not supported in the standard SAML 2.0 metadata documents.
      Examples of such settings are requirements for message signing, IDP discovery and security profiles.</p>
            <p>Extended metadata is defined using
      <span class="emphasis"><em>org.springframework.security.saml.metadata.ExtendedMetadata</em></span> beans embedded inside ExtendedMetadataDelegate for each SP or IDP metadata definition.
      In case a single metadata document contains multiple identity providers (in multiple EntityDescriptor elements), extended metadata can be set separately for each of them using a map with
      entity IDs as keys, e.g.: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		metadata provider bean
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;!-- Default extended metadata for entities not specified in the map --&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;!-- Extended metadata for specific IDPs --&gt;
		&lt;map&gt;
			&lt;entry key="http://idp.ssocircle.com"&gt;
				&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
			&lt;/entry&gt;
		&lt;/map&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
            <p>The following table summarizes settings available in the extended metadata. The same class is
                used for both local service providers and remote identity providers; each value contains information
                about the entities it's valid for.
                </p><div class="table"><a name="configuration-metadata-extended-settings" href="#configuration-metadata-extended-settings"></a><p class="title"><b>Table&nbsp;7.2.&nbsp;Extended metadata settings</b></p><div class="table-contents">
                    
                    <table summary="Extended metadata settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"><col align="left" class="_3"><col align="left" class="_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Default</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Entities</th><th style="border-bottom: 0.5pt solid ; " align="left">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">false</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">True for metadata of a local service provider. False for remote identity
                                    providers.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">alias</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Unique alias used to identify the selected local service provider based on
                                    used URL. See <a class="xref" href="#configuration-entity-alias" title="7.4&nbsp;Multi-tenancy and entity alias">Section&nbsp;7.4, &#8220;Multi-tenancy and entity alias&#8221;</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">signMetadata</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">false</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">When true generated metadata will be signed using XML Signature using certificate with alias of <code class="literal">signingKey</code>.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">idpDiscoveryEnabled</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">false</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">When true system will initialize IDP discovery when no IDP is selected during
                                    SSO initialization. See <a class="xref" href="#configuration-discovery" title="9.1&nbsp;IDP selection and discovery">Section&nbsp;9.1, &#8220;IDP selection and discovery&#8221;</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">idpDiscoveryURL</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">internal discovery URL</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">URL of the IDP discovery service. Only used when discovery is enabled.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">idpDiscoveryResponseURL</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">internal discovery URL</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">URL expecting response from the IDP discovery service. Only used when
                                    discovery is enabled.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">ecpEnabled</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">false</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Property enables support for the SAML 2.0 ECP profile. See <a class="xref" href="#enhanced-client" title="10.4&nbsp;Enhanced client/proxy">Section&nbsp;10.4, &#8220;Enhanced client/proxy&#8221;</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">securityProfile</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">metaiop</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Security profile for verification of message signatures. See <a class="xref" href="#configuration-security-profiles" title="8.2&nbsp;Security profiles">Section&nbsp;8.2, &#8220;Security profiles&#8221;</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">sslSecurityProfile</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">pkix</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Security profile for vericiation of SSL/TLS endpoint trust. See <a class="xref" href="#configuration-security-profiles" title="8.2&nbsp;Security profiles">Section&nbsp;8.2, &#8220;Security profiles&#8221;</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">sslHostnameVerification</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">default</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Verification of hostnames for HTTPS calls (e.g. in Artifact resolution).
                                    Allowed values are <span class="emphasis"><em>default</em></span>, <span class="emphasis"><em>defaultAndLocalhost</em></span>,
                                    <span class="emphasis"><em>strict</em></span> and <span class="emphasis"><em>allowAll</em></span>. Value <span class="emphasis"><em>allowAll</em></span>
                                    effectively disables hostname verification. All values are case-insensitive. For
                                    more details on the supported hostname verifications see
                                    <a class="link" href="#">Commons-SSL JavaDoc</a>.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">signingAlgorithm</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">-</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local only</td><td style="border-bottom: 0.5pt solid ; " align="left">Algorithm used to create digital signature on the metadata object. Typical values are <span class="emphasis"><em>http://www.w3.org/2000/09/xmldsig#rsa-sha1</em></span>,
                                  <span class="emphasis"><em>http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</em></span> and <span class="emphasis"><em>http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</em></span>.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">signingKey</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">-</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">For local entities alias of private key used to create signatures. The
                                    default private key is used when no value is provided. For remote identity
                                    providers defines an additional public key used to verify signatures.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">encryptionKey</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">-</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">For local entities alias of private key used to encrypt data. The default
                                    private key is used when no value is provided. For remote identity providers
                                    defines an additional public key used to decrypt data.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">tlsKey</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">-</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">For local entities alias of private key used for SSL/TLS client
                                    authentication. No client authentication is used when value is not specified.
                                    For remote identity providers defines an additional public key used for trust
                                    resolution.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">trustedKeys</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">-</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">remote</td><td style="border-bottom: 0.5pt solid ; " align="left">Keys included as trusted anchors during PKIX evaluation. All keys in the
                                    keyStore are used as trust anchors with null value. Keys are only used with PKIX
                                    security profile.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">requireLogoutRequestSigned</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">true</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">For local entities enables requirement of signed logout requests. For remote
                                    entities enables signing of requests sent to the IDP.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">requireLogoutResponseSigned</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">false</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">local and remote</td><td style="border-bottom: 0.5pt solid ; " align="left">For local entities enables requirement of signed logout responses. For remote
                                    entities enables signing of responses sent to the IDP.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">requireArtifactResolveSigned</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">true</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">remote only</td><td style="border-bottom: 0.5pt solid ; " align="left">Enables signing of artifact resolution requests sent to the remote identity
                                    providers.
                                </td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">supportUnsolicitedResponse</td><td style="border-right: 0.5pt solid ; " align="left">true</td><td style="border-right: 0.5pt solid ; " align="left">remote only</td><td style="" align="left">Enables support for Unsolicited Responses (IDP-Initialized SSO) sent from 
                                    this remote entity.
                                </td></tr></tbody></table>
                </div></div><p><br class="table-break">
            </p>
            <p>For additional examples on setting up metadata and extended metadata see
                <a class="xref" href="#configuration-metadata-sp" title="7.1&nbsp;Service provider metadata">Section&nbsp;7.1, &#8220;Service provider metadata&#8221;</a> for local SP, and <a class="xref" href="#configuration-metadata-idp" title="7.2&nbsp;Identity provider metadata">Section&nbsp;7.2, &#8220;Identity provider metadata&#8221;</a>
                for remote IDPs.
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-entity-alias" href="#configuration-entity-alias"></a>7.4&nbsp;Multi-tenancy and entity alias</h2></div></div></div>
            
            <p>Spring SAML contains limited support for multi-tenancy. It is possible to define configuration for multiple instances of local service providers, where each
                can have different URLs and security settings. System is differentiating between the service provider instances using <span class="emphasis"><em>entity alias</em></span> which
                is a unique identifier within deployment of Spring SAML.</p>
            <p><span class="emphasis"><em>Entity alias</em></span> is appended to URLs of SAML endpoints and used by Spring SAML to identify the correct instance.
                For example for local service provider with <span class="emphasis"><em>entity alias</em></span>
                <span class="emphasis"><em>customer123</em></span> the standard URL <span class="emphasis"><em>scheme://server:port/contextPath/saml/login</em></span> becomes
                <span class="emphasis"><em>scheme://server:port/contextPath/saml/login/alias/customer123</em></span>.</p>
            <p>The entity alias functionality can only be used together with pre-configured metadata (see <a class="xref" href="#configuration-metadata-sp-import" title="7.1.2&nbsp;Pre-configured metadata">Section&nbsp;7.1.2, &#8220;Pre-configured metadata&#8221;</a>).
                The <span class="emphasis"><em>entity alias</em></span> is specified in the extended metadata of each of the configured service providers.</p>
            <p>Spring SAML doesn't enforce any limitations on which Identity Provider can be deliver messages to which of the local Service Providers. In case your application
            requires similar rules (for example only certain tenants can authenticate using a specific IDP), make sure to implement them for example in your <span class="emphasis"><em>SAMLUserDetailsService</em></span> (for single sign-on).</p>
            <p>Selection of the correct Service Provider instance based on URL is performed inside <span class="emphasis"><em>SAMLContextProviderImpl</em></span> class.</p>
        </div>
    </div>

    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="security" href="#security"></a>8.&nbsp;Security configuration</h2></div></div></div>
        
        <p>
            SAML Extension requires configuration of security settings which include cryptographic
            material used for digital signatures and encryption, security profiles for configuration of trusted
            cryptographic material provided by remote entities and verifications of HTTPS connections.
        </p>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-key-management" href="#configuration-key-management"></a>8.1&nbsp;Key management</h2></div></div></div>
            
            <p>
                SAML exchanges involve usage of cryptography for signing and encryption of data. All interaction with cryptographic keys is
                done through interface <span class="emphasis"><em>org.springframework.security.saml.key.KeyManager</em></span>. The default implementation
                <span class="emphasis"><em>org.springframework.security.saml.key.JKSKeyManager</em></span> relies on a single JKS key store which contains 
                all private and public keys. KeyManager should contain at least one private key which should be marked as default by using 
                the alias of the private key as part of the <span class="emphasis"><em>JKSKeyManager</em></span> constructor.
            </p>
            <p>
                In case your application doesn't need to create digital signatures and/or decrypt incoming messages, it is possible to use an empty 
                implementation of the keystore which doesn't require any JKS file - <span class="emphasis"><em>org.springframework.security.saml.key.EmptyKeyManager</em></span>. 
                This can be the case for example when using only IDP-Initialized single sign-on. Please note that when using the <span class="emphasis"><em>EmptyKeyManager</em></span> 
                some of Spring SAML features will be unavailable. This includes at least SP-initialized Single Sign-on, Single Logout, usage of additional 
                keys in <span class="emphasis"><em>ExtendedMetadata</em></span> and verification of metadata signatures. Use the following bean in order to initialize the <span class="emphasis"><em>EmptyKeyManager</em></span>:
</p><pre class="programlisting">&lt;bean id="keyManager" class="org.springframework.security.saml.key.EmptyKeyManager"/&gt;</pre><p>
            </p>
            <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-jks" href="#configuration-key-management-jks"></a>8.1.1&nbsp;Sample JKS keystore</h3></div></div></div>
                
                <p>Sample application contains a default JKS key store with a sample private certificate usable for test purposes. The key store
                    is defined as:</p><pre class="programlisting">&lt;bean id="keyManager" class="org.springframework.security.saml.key.JKSKeyManager"&gt;
	&lt;constructor-arg value="classpath:security/samlKeystore.jks"/&gt;
	&lt;constructor-arg type="java.lang.String" value="nalle123"/&gt;
	&lt;constructor-arg&gt;
	&lt;map&gt;
		&lt;entry key="apollo" value="nalle123"/&gt;
	&lt;/map&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg type="java.lang.String" value="apollo"/&gt;
&lt;/bean&gt;</pre>
                 <p>The first argument points to the used key store file, second contains password for the keystore, third then map with
                 passwords for private keys with alias-password value pairs. Alias of the default certificate is the last parameter.</p>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-private-keys" href="#configuration-key-management-private-keys"></a>8.1.2&nbsp;Generating and importing private keys</h3></div></div></div>
                 
                 <p>Private keys (with either self-signed or CA signed certificates) are used to digitally sign SAML messages,
                 encrypt their content and in some cases for SSL/TLS Client authentication of your service provider application.
                 SAML Extension ships with a default private key in the <span class="emphasis"><em>samlKeystore.jks</em></span> with alias <span class="emphasis"><em>apollo</em></span>
                 which can be used for initial testing, but for security reason should be replaced with your own key in early development stages.</p>
                 <p>In case your IDP doesn't require keys signed by a specific certification authority you can generate your own self-signed key using the
                 Java utility <span class="emphasis"><em>keytool</em></span>, e.g. with: </p><pre class="programlisting">keytool -genkeypair -alias some-alias -keypass changeit -keystore samlKeystore.jks</pre>
                 <p>The keystore will now contain additional PrivateKeyEntry with alias <span class="emphasis"><em>mykey</em></span> which can be imported to the <span class="emphasis"><em>keyManager</em></span> in your <span class="emphasis"><em>securityContext.xml</em></span>.</p>
                 <p>Keys signed by certification authorities are typically provided in .p12/.pfx format (or can be converted to such using OpenSSL) and imported to Java keystore with, e.g.:
                 </p><pre class="programlisting">keytool -importkeystore -srckeystore key.p12 -srcstoretype PKCS12 -srcstorepass password \
	-alias some-alias -destkeystore samlKeystore.jks -destalias some-alias \
	-destkeypass changeit</pre>
    <p>The following command can be used to determine available alias in the p12 file: </p><pre class="programlisting">keytool -list -keystore key.p12 -storetype pkcs12</pre>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-public-keys" href="#configuration-key-management-public-keys"></a>8.1.3&nbsp;Importing public keys</h3></div></div></div>
                 
                 <p>Cryptographic material used to decrypt incoming data and verify trust of signatures in SAML messages and metadata is stored either
                 in metadata of remote entities or in the <span class="emphasis"><em>keyManager</em></span>. In order to import additional trusted key to the keystore
                 run, e.g.: </p><pre class="programlisting">keytool -importcert -alias some-alias -file key.cer -keystore samlKeystore.jks</pre>
                 <p>Imported keys can be referenced in ExtendedMetadataDelegate and ExtendedMetadata beans,
                 for details see <a class="xref" href="#configuration-metadata-idp-signature" title="7.2.4&nbsp;Metadata signature verification">Section&nbsp;7.2.4, &#8220;Metadata signature verification&#8221;</a> and <a class="xref" href="#configuration-security-profiles" title="8.2&nbsp;Security profiles">Section&nbsp;8.2, &#8220;Security profiles&#8221;</a>.</p>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-ssl-keys" href="#configuration-key-management-ssl-keys"></a>8.1.4&nbsp;Loading SSL/TLS certificates</h3></div></div></div>
                 
                 <p>Direct SSL/TLS connections (used with HTTP-Artifact binding) require verification of the public key presented by the server.
                 The <a class="ulink" href="https://github.com/vschafer/ssl-extractor" target="_top">SSL Extractor utility</a> can be used to extract certificates presented by an SSL/TLS
                 endpoint, e.g. with: </p><pre class="programlisting">java -jar sslextractor-0.9.jar www.google.com 443</pre>
                 <p>The certificates are stored as .cer files and can be imported to the keystore as a usual public key. For details about
                 configuring of trust for SSL/TLS connections see <a class="xref" href="#configuration-security-profiles" title="8.2&nbsp;Security profiles">Section&nbsp;8.2, &#8220;Security profiles&#8221;</a>.</p>
             </div>
         </div>
         <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-security-profiles" href="#configuration-security-profiles"></a>8.2&nbsp;Security profiles</h2></div></div></div>
             
             <p>Exchanges of messages between identity providers and service providers with SAML protocol
                 involves usage of digital signatures. Signatures are typically constructed using means of asymetric
                 cryptography and public key infrastructure with public and private keys signed by trusted certification
                 authorities. Signatures are either applied directly to parts of XML representation of SAML messages
                 using XML Signature or are part of the transport layer used to deliver the message like SSL/TLS.
             </p>
             <p>Verification of signatures is executed in two phases. Signature is first checked for validity by
                 comparing digital hash included as part of the signature with value calculated from the content.
                 Subsequently it is verified whether party who created the signature is trusted by the recipient. Spring Security SAML
                 provides two mechanisms for defining which signatures should be accepted - metadata interoperability
                 mode and PKIX mode.
             </p>
             <p>
                 Security profiles are defined in Extended Metadata of your local SP. Profile can be defined separately
                 for XML Signatures using property <span class="emphasis"><em>securityProfile</em></span> and for SSL/TLS Signatures using
                 property<span class="emphasis"><em>sslSecurityProfile</em></span>. Value of both properties can be either <span class="emphasis"><em>metaiop</em></span>
                 or <span class="emphasis"><em>pkix</em></span>. For details about using Extended Metadata see <a class="xref" href="#configuration-metadata" title="7.&nbsp;Metadata configuration">Chapter&nbsp;7, <i>Metadata configuration</i></a>,
                 for reference of allowed values see <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a>.
             </p>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-metaiop" href="#configuration-security-profiles-metaiop"></a>8.2.1&nbsp;Metadata interoperability profile (MetaIOP)</h3></div></div></div>
                 
                 <p>With MetaIOP mode certificates are not checked for expiration or revocation and certificate paths
                     are not
                     verified. This means that it does not matter which certification authority issued the certificate,
                     as the fact whether the certificate is trusted or not is conveyed using other mechanisms (e.g. by
                     secure metadata exchange or digital signature of metadata itself).
                 </p>
                 <p>Signature is deemed trusted when the certificate used to create it is included in one
                     of the following places:
                     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
                             <p>Key with usage of signing or unspecified in entity metadata of a remote entity</p>
                         </li><li class="listitem">
                             <p>Signing key specified in property <span class="emphasis"><em>signingKey</em></span> of extended metadata of a remote entity</p>
                         </li></ul></div><p>
                 </p>
                 <p>
                     MetaIOP is the default profile for verification of XML signatures. For details about this profile
                     see <a class="ulink" href="http://docs.oasis-open.org/security/saml/Post2.0/sstc-metadata-iop.pdf" target="_top">the specification</a>.
                 </p>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-pkix" href="#configuration-security-profiles-pkix"></a>8.2.2&nbsp;PKIX profile</h3></div></div></div>
                 
                 <p>
                     With PKIX profile trust of signature certificates is verified based on a certificate path
                     between trusted CA certificates and the certificate in question. Certificate is trusted when it's
                     possible to construct path from a trusted certificate to the validated one. With this profile
                     certificate expiration and revocation can be checked.
                 </p>
                 <p>Trusted keys (anchors) for PKIX verification of signatures are combined from the following places:
                     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
                             <p>Key with usage of signing or unspecified in entity metadata of a remote entity</p>
                         </li><li class="listitem">
                             <p>Signing key specified in property <span class="emphasis"><em>signingKey</em></span> of extended metadata of a remote entity</p>
                         </li><li class="listitem">
                             <p>All keys specified in <span class="emphasis"><em>trustedKeys</em></span> set of extended metadata of a remote entity,
                                 or all keys available in the key store when the property is null (default value)</p>
                         </li></ul></div><p>
                 </p>
           <p>Please note that trust anchors are treated as automatically trusted and are not necessarily subject to all checks as leaf certificates are (depending
           on your security provider implementation). You should preferably use only your CA and intermediary CA certificates as trust anchors. In case you want to ignore
           certificates available in your XML metadata and only use settings from your manually set ExtendedMetadata, set property <span class="emphasis"><em>useXmlMetadata</em></span>
           of your <span class="emphasis"><em>metadataResolver</em></span> to false:
               </p><pre class="programlisting">&lt;bean id="contextProvider" class="org.springframework.security.saml.context.SAMLContextProviderImpl"&gt;
	&lt;property name="metadataResolver"&gt;
		&lt;bean class="org.springframework.security.saml.trust.MetadataCredentialResolver"&gt;
			&lt;constructor-arg index="0" ref="metadata"/&gt;
			&lt;constructor-arg index="1" ref="keyManager"/&gt;
			&lt;property name="useXmlMetadata" value="false"/&gt;
		&lt;/bean&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre><p>
           </p>
           <p>PKIX verification supports checking of CRLs (certificate revocation lists) using the default underlaying Java Security Provider
           (e.g. Sun JCE, BouncyCastle JCE).
           </p>
           <p>The PKIX algorithm needs to be advised that the revocation checking is enabled. You can do so by customizing the <span class="emphasis"><em>pkixTrustEvaluator</em></span> inside <span class="emphasis"><em>SAMLContextProvider</em></span>, see an example with properties <span class="emphasis"><em>forceRevocationEnabled</em></span> and <span class="emphasis"><em>revocationEnabled</em></span> bellow.</p>
           <p>By default the validation algorithm only uses the <span class="emphasis"><em>CertPathBuilder</em></span>. Some Java security implementations do not support full feature set of revocation checking in this class and only
            implement them in the <span class="emphasis"><em>CertPathValidator</em></span> (e.g. Sun provider only supports OCSP in CertPathBuilder since Java 1.8). You can instruct system to use both
            <span class="emphasis"><em>CertPathBuilder</em></span> and <span class="emphasis"><em>CertPathValidator</em></span> by setting property <span class="emphasis"><em>validateCertPath</em></span> to <span class="emphasis"><em>true</em></span> on bean
            <span class="emphasis"><em>CertPathPKIXTrustEvaluator</em></span>.</p>
            <p>The security provider used for loading of PKIX verification factories can be customized using property <span class="emphasis"><em>securityProvider</em></span>.</p>
            <pre class="programlisting">&lt;bean id="contextProvider" class="org.springframework.security.saml.context.SAMLContextProviderImpl"&gt;
	&lt;property name="pkixTrustEvaluator"&gt;
		&lt;bean class="org.springframework.security.saml.trust.CertPathPKIXTrustEvaluator"&gt;
			&lt;property name="PKIXValidationOptions"&gt;
				&lt;bean class="org.opensaml.xml.security.x509.CertPathPKIXValidationOptions"&gt;
					&lt;property name="forceRevocationEnabled" value="true"/&gt;
					&lt;property name="revocationEnabled" value="true"/&gt;
				&lt;/bean&gt;
			&lt;/property&gt;
			&lt;property name="validateCertPath" value="true"/&gt;
			&lt;property name="securityProvider" value="SUN"/&gt;
		&lt;/bean&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre><p>
             </p>
             <p>Spring SAML uses standard CertPath verification API. The default Sun JCE provider supports automatic revocation checking based on the certificate's CRL Distribution Points Extension
                 (by setting system property <span class="emphasis"><em>com.sun.security.enableCRLDP</em></span> to true), CRL point defined using certificate's Authority
                 Information Access (AIA) Extension (by setting system property <span class="emphasis"><em>com.sun.security.enableAIAcaIssuers</em></span> to true)
                 and OCSP (by setting system property <span class="emphasis"><em>ocsp.enable</em></span> to true).
                 For details see the <a class="ulink" href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/certpath/CertPathProgGuide.html#AppB" target="_top">Java PKI Programmer's Guide</a>.
                 In case you are using another security provider, please consult its manual for functionality related to <span class="emphasis"><em>CertPathBuilder</em></span> and <span class="emphasis"><em>CertPathValidator</em></span>
                 with the <span class="emphasis"><em>PKIX</em></span> algorithm.
             </p>
               <p>You can also manually populate CRLs by extending class <span class="emphasis"><em>org.springframework.security.saml.trust.PKIXInformationResolver</em></span> and overriding method <span class="emphasis"><em>populateCRLs</em></span>
               with your own CRL population logic. Populated CRLs are automatically added to the PKIX verification mechanism. The customized class needs to be set to property <span class="emphasis"><em>pkixResolver</em></span>
               in the <span class="emphasis"><em>contextProvider</em></span> bean.
               </p>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-customization" href="#configuration-security-profiles-customization"></a>8.2.3&nbsp;Custom profile</h3></div></div></div>
                     
                     <p>
                         Engine used to verify trust of signatures for given combination of SP/IDP is created in methods
                         <span class="emphasis"><em>populateTrustEngine</em></span> and <span class="emphasis"><em>populateSSLTrustEngine</em></span> of interface
                         <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProvider</em></span> and can be overriden
                         with custom implementation. See <a class="xref" href="#configuration-context-provider" title="10.2&nbsp;Context provider">Section&nbsp;10.2, &#8220;Context provider&#8221;</a> for details on context customization.
                     </p>
             </div>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-security-profiles-hostnames" href="#configuration-security-profiles-hostnames"></a>8.3&nbsp;Hostname verification for HTTPS connections</h2></div></div></div>
            
            <p>
                Connections to HTTPS services (e.g. during Artifact resolution) require verification that the connected hostname
                corresponds with the hostname defined in the service's public certificate. Hostname verification is enabled
                by default.
            </p>
            <p>
                Verification can be disabled by setting ExtendedMetadata property <span class="emphasis"><em>sslHostnameVerification</em></span>
                of the local SP entity to <span class="emphasis"><em>allowAll</em></span>. For details on using the ExtendedMetadata see <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a>.
            </p>
            <p>
                All supported values can be found in the ExtendedMetadata reference <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a>.
            </p>
        </div>
    </div>

    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="configuration-sso" href="#configuration-sso"></a>9.&nbsp;Single sign-on configuration</h2></div></div></div>
        
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-discovery" href="#configuration-discovery"></a>9.1&nbsp;IDP selection and discovery</h2></div></div></div>
            
            <p>Discovery helps your Service Provider determine which Identity Provider should be used for authentication of the current user. It is automatically initialized during calls to 
            single sign-on endpoint at <span class="emphasis"><em>scheme://server:port/contextPath/saml/login</em></span>. SAML Extension supports multiple modes of discovery including 
            the <a class="ulink" href="http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-idp-discovery.pdf" target="_top">Identity Provider Discovery Service Protocol and Profile</a>.</p>
            <p>
              IDP discovery modes can always be skipped during SSO initialization by specifying HTTP request parameter <span class="emphasis"><em>idp</em></span> with the
              entityId of the required IDP, e.g. <span class="emphasis"><em>scheme://server:port/contextPath/saml/login?idp=mySelectedIDP</em></span>.
            </p>
            <p>
              The URL where local SP expects discovery response can be included in the SP metadata as one of the extensions. The feature can be enabled by setting property <span class="emphasis"><em>includeDiscoveryExtension</em></span>
              to true on bean <span class="emphasis"><em>MetadataGenerator</em></span> inside <span class="emphasis"><em>MetadataGeneratorFilter</em></span>, e.g.:
        </p><pre class="programlisting">&lt;bean id="metadataGeneratorFilter" class="org.springframework.security.saml.metadata.MetadataGeneratorFilter"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
			&lt;property name="includeDiscoveryExtension" value="true"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre><p>
            </p>
            <p>
              </p><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1094" href="#d5e1094"></a>Default IDP without discovery</h2></div></div></div>
                
                <p>The mode is enabled by default and automatically selects the default IDP without performing discovery.</p>
                <p>The default IDP can be configured using property <span class="emphasis"><em>defaultIDP</em></span> on bean <span class="emphasis"><em>metadata</em></span> in the Spring Security configuration. 
                In case the property isn't set, system will automatically use the first available IDP.</p>
              </div><p>
              </p><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1100" href="#d5e1100"></a>Local discovery service</h2></div></div></div>
                
                <p>SAML Extension includes a local IDP discovery service which presents user with an IDP selection page. This mode can be enabled by setting property <span class="emphasis"><em>includeDiscovery</em></span> in the
                <a class="link" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">local SP extended metadata</a> to <span class="emphasis"><em>true</em></span>.</p> 
                <p>The selection page can be customized using property <span class="emphasis"><em>idpSelectionPath</em></span> on bean <span class="emphasis"><em>samlIDPDiscovery</em></span>. System forwards to this page wih a discovery request which includes the following request attributes:
                  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                            <p><span class="emphasis"><em>idpDiscoReturnURL</em></span> - URL to send the IDP selection result to using GET action</p>
                        </li><li class="listitem">
                            <p><span class="emphasis"><em>idpDiscoReturnParam</em></span> - name of the GET parameter to include the entity ID of the selected IDP</p>
                        </li></ul></div><p>
                </p>
                <p>See the default implementation in <span class="emphasis"><em>sample/src/main/webapp/WEB-INF/security/idpSelection.jsp</em></span> for an example.</p>
              </div><p>
              </p><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1118" href="#d5e1118"></a>Remote discovery service</h2></div></div></div>
                
                <p>In order to enable external IDP discovery service configure property <span class="emphasis"><em>idpDiscoveryURL</em></span> in your <a class="link" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">local
                SP extended metadata</a> to the external discovery URL. Make sure property <span class="emphasis"><em>idpDiscoveryEnabled</em></span> is set to true. The remote discovery service needs to support
                the Identity Provider Discovery Service Protocol and Profile.</p>
              </div><p>
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-sso-process" href="#configuration-sso-process"></a>9.2&nbsp;Single sign-on process</h2></div></div></div>
            
            <p>Spring SAML Extension supports both SP-initialized and IDP-initialized single sign-on.</p>        
            <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-sso-process-sp-init" href="#configuration-sso-process-sp-init"></a>9.2.1&nbsp;Service provider initialized SSO</h3></div></div></div>
                 
                 <p>SP initialized SSO process can be started in two ways:
                 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                         <p>User accesses a resource protected by Spring Security which initializes SAMLEntryPoint</p>
                     </li><li class="listitem">
                         <p>User is redirected to the SSO endpoint at e.g. https://www.server.com/context/saml/login</p>
                     </li></ul></div><p>
                 </p>
                 <p>After identification of IDP to use for authentication (for details see <a class="xref" href="#configuration-discovery" title="9.1&nbsp;IDP selection and discovery">Section&nbsp;9.1, &#8220;IDP selection and discovery&#8221;</a>), SAML Extension creates an AuthnRequest SAML message
                 and sends it to the selected IDP. Both construction of the AuthnRequest and binding used to send it can be customized using <span class="emphasis"><em>WebSSOProfileOptions</em></span>
                 object. SAMLEntryPoint determines <span class="emphasis"><em>WebSSOProfileOptions</em></span> configuration to use by calling method <span class="emphasis"><em>getProfileOptions</em></span>.
                 The default implementation returns the value specified in property <span class="emphasis"><em>defaultOptions</em></span>. The method can be overriden to provide custom logic for SSO initialization.</p>
                 <p>Default settings for <span class="emphasis"><em>WebSSOProfileOptions</em></span> can be specified in bean <span class="emphasis"><em>samlEntryPoint</em></span> of your <span class="emphasis"><em>securityContext.xml</em></span>, e.g.:
                 </p><pre class="programlisting">&lt;bean id="samlEntryPoint" class="org.springframework.security.saml.SAMLEntryPoint"&gt;
	&lt;property name="defaultProfileOptions"&gt;
		&lt;bean class="org.springframework.security.saml.websso.WebSSOProfileOptions"&gt;
			&lt;property name="binding" value="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"/&gt;
			&lt;property name="includeScoping" value="false"/&gt;
		&lt;/bean&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre>
                <p>WebSSOProfileOptions supports the following settings:
                    </p><div class="table"><a name="configuration-sso-webssoprofile-table" href="#configuration-sso-webssoprofile-table"></a><p class="title"><b>Table&nbsp;9.1.&nbsp;<span class="emphasis"><em>org.springframework.security.saml.websso.WebSSOProfileOptions</em></span> parameters</b></p><div class="table-contents">
                     
                     <table summary="org.springframework.security.saml.websso.WebSSOProfileOptions parameters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-bottom: 0.5pt solid ; " align="left">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">binding</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: binding of the first declared SingleSignOnService in IDP metadata. Binding used to send message to IDP. Supported values depend on the SP configuration, typically "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST", "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect",
                    "urn:oasis:names:tc:SAML:2.0:bindings:PAOS" and "urn:oasis:names:tc:SAML:2.0:profiles:holder-of-key:SSO:browser".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">providerName</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. Human readable name of the local SP sent with the authentication request.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">assertionConsumerIndex</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. When set determines where should IDP send response and which binding to use. Otherwise system uses the default assertion consumer service marked as default, or first applicable. Available indexes can be found in metadata of this service provider.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">nameID</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. Name ID to request from IDP in the NameIDPolicy. No NameIDPolicy is sent when not specified. Typical values are "urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress", "urn:oasis:names:tc:SAML:2.0:nameid-format:transient", "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent", "urn:oasis:names:tc:SAML:2.0:nameid-format:encrypted".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">allowCreate</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. Only applicable when nameID is specified, when true instructs IDP that it is allowed to create new user based on the authentication request.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">passive</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: false. Sets whether the IdP should refrain from interacting with the user during the authentication process.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">forceAuthn</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: false. When true IDP is required to re-authenticate user and not rely on previous authentication events.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">includeScoping</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: true. When true request will include Scoping element.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">allowedIDPs</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. Values to be included in the Scoping element on top of the IDP message is sent to. Only applicable when includeScoping is set to true.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">proxyCount</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: 2. Determines value to be used in the proxyCount attribute of the scope in the AuthnRequest. Use zero to disable proxying or value &gt;0 to specify how many hops are allowed. Only applicable when includeScoping is set to true.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">authnContexts</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: empty. Authentication contexts IDP is allowed to use when authenticating user. See <a class="ulink" href="http://docs.oasis-open.org/security/saml/v2.0/saml-authn-context-2.0-os.pdf" target="_top">the specification</a> for details.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">authnContextComparison</td><td style="border-bottom: 0.5pt solid ; " align="left">Default: AuthnContextComparisonTypeEnumeration.EXACT. Mechanism used by IDP to determine authentication method to use. See <a class="ulink" href="http://docs.oasis-open.org/security/saml/v2.0/saml-authn-context-2.0-os.pdf" target="_top">the specification</a> for details.</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">relayState</td><td style="" align="left">Default: empty. Value is sent to IDP and provided back to SP as part of the authentication response.</td></tr></tbody></table>
                </div></div><p><br class="table-break">
                </p>
                <p>The AuthnRequest message is sent unencrypted on message level. If needed, encryption should be provided by SSL/TLS on transport layer.</p>
            </div>
            <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-sso-process-idp-init" href="#configuration-sso-process-idp-init"></a>9.2.2&nbsp;Identity provider initialized SSO</h3></div></div></div>
                
                <p>Spring SAML supports reception of Unsolicited Response messages (so called IDP-initialized SSO). In this scenario IDP creates a Response object in the same way as if it was replying to 
                an AuthnRequest message sent from SP, but it omits the InResponseTo parameter. Message is then sent to the AssertionConsumerURL of Spring SAML (typically 
                <span class="emphasis"><em>scheme://server:port/contextPath/saml/SSO</em></span>) using one of the supported bindings. List of all available endpoints and bindings can be found in the metadata
                of the Spring SAML application.</p>
                <p>Received Unsolicited Respose message is processed and validated in exactly the same way as with SP-Initialized SSO.</p>
                <p>Support for unsolicited messages can be disabled in the ExtendedMetadata of remote entities using property <span class="emphasis"><em>supportUnsolicitedResponse</em></span>.</p>
            </div>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-logout" href="#configuration-logout"></a>9.3&nbsp;Logout process</h2></div></div></div>
            
            <p>Spring SAML Extension supports both Local Logout and Single Logout mechanisms.</p>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-logout-local" href="#configuration-logout-local"></a>9.3.1&nbsp;Local logout</h3></div></div></div>
                     
                     <p>
                         Local logout terminates only the local session and doesn't affect neither session at IDP, nor sessions at other SPs where user logged in using single sign-on. Local logout
                 can be initialized at <span class="emphasis"><em>scheme://server:port/contextPath/saml/logout?local=true</em></span>. Call is intercepted by bean <span class="emphasis"><em>samlLogoutFilter</em></span> which can be configured with
                 the following settings:
               </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                         <p>Instance of interface <span class="emphasis"><em>org.springframework.security.web.authentication.logout.LogoutSuccessHandler</em></span> (constructor index 0) which determines operation to perform after successful logout (e.g. redirect to a logout landing page). By default user gets redirected to page <span class="emphasis"><em>logout.jsp</em></span>.</p>
                     </li><li class="listitem">
                         <p>Instances of interface <span class="emphasis"><em>org.springframework.security.web.authentication.logout.LogoutHandler</em></span> (constructor index 1) which are responsible for destruction of user's session. The default handler <span class="emphasis"><em>org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler</em></span> logs the user out by removing the Authentication object, but leaves the HTTP session opened.</p>
                     </li></ul></div>
              <p>It is also possible to configure local logout using standard Spring Security element <span class="emphasis"><em>&lt;security:logout&gt;</em></span> inside <span class="emphasis"><em>&lt;security:http&gt;</em></span> block. For example:
                  </p><pre class="programlisting">&lt;security:http&gt;
	&lt;security:logout logout-url="/j_logout" logout-success-url="/logout.jsp"/&gt;
&lt;/security:http&gt;</pre>
             </div>
             <div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-logout-global" href="#configuration-logout-global"></a>9.3.2&nbsp;Global logout</h3></div></div></div>
                     
                     <p>Global logout implements the SAML 2.0 Single Logout profile which terminates both session at the current SP, the IDP session and sessions at other SPs connected to the same IDP session. Single Logout
                 can be initialized from any of the participaing SPs or from the IDP.</p>
                 <p>Single Logout is currently supported with HTTP-Redirect and HTTP-POST bindings. SOAP binding is not available.</p>
                 <p>Global logout can be initialized at <span class="emphasis"><em>scheme://server:port/contextPath/saml/logout</em></span>. System automatically determines which IDP to send the request to based on the currently authenticated user. Single logout can be configured using beans <span class="emphasis"><em>samlLogoutFilter</em></span> and <span class="emphasis"><em>samlLogoutProcessingFilter</em></span> with the following options:
                 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                         <p>Bean <span class="emphasis"><em>samlLogoutFilter</em></span> can be provided with instances of interface <span class="emphasis"><em>org.springframework.security.web.authentication.logout.LogoutHandler</em></span> (constructor index 3). The handlers are called before sending SAML 2.0 LogoutRequest to the IDP when initializing Single Logout from the current SP.</p>
                     </li><li class="listitem">
                         <p>Bean <span class="emphasis"><em>samlLogoutProcessingFilter</em></span> can be provided with instance of interface <span class="emphasis"><em>org.springframework.security.web.authentication.logout.LogoutSuccessHandler</em></span> (constructor index 0). Handler is called after successful finalization of Single Logout process (reception of LogoutResponse from IDP) and determines operation to perform after logout (e.g. redirect to a logout landing page). By default user gets redirected to page <span class="emphasis"><em>logout.jsp</em></span>.</p>
                     </li><li class="listitem">
                         <p>Bean <span class="emphasis"><em>samlLogoutProcessingFilter</em></span> can be provided with instances of interface <span class="emphasis"><em>org.springframework.security.web.authentication.logout.LogoutHandler</em></span> (constructor index 1). The handlers are called after successful reception of SAML 2.0 LogoutRequest or LogoutResponse from the IDP.</p>
                     </li></ul></div>
                 <p>Spring SAML correctly handles SAML 2.0 LogoutRequest messages sent from the IDP and performs logout in case the message is valid. In case of invalid data (missing signature, invalid issuer, invalid issue time, invalid destination, invalid session index, invalid name ID, no user logged in) system responds with SAML 2.0 LogoutResponse with an error Status code.</p>
             </div>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-authentication-object" href="#configuration-authentication-object"></a>9.4&nbsp;Authentication object</h2></div></div></div>
            
            <p>Successful authentication using SAML token results in creation of an <span class="emphasis"><em>Authentication</em></span> object by
            the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>. By default instance of <span class="emphasis"><em>org.springframework.security.providers.ExpiringUsernameAuthenticationToken</em></span>
            is created. Content of the resulting object can be customized by setting properties of the <span class="emphasis"><em>samlAuthenticationProvider</em></span> bean in the <span class="emphasis"><em>securityContext.xml</em></span>.
            An instance of <span class="emphasis"><em>org.springframework.security.saml.userdetails.SAMLUserDetailsService</em></span> can be provided to supply application-specific information about the
            authenticated user.</p>
            <p>The <span class="emphasis"><em>Authentication</em></span> object will by default include string version of the <span class="emphasis"><em>NameID</em></span> included in the SAML Assertion as its<span class="emphasis"><em>principal</em></span>. 
            Property <span class="emphasis"><em>forcePrincipalAsString</em></span> can be used to change this to include the raw <span class="emphasis"><em>NameID</em></span> element.</p>
            <p>The Authentication object is available in pages secured with Spring Security using <span class="emphasis"><em>SecurityContextHolder.getContext().getAuthentication()</em></span> and is populated with the following values:
            </p><div class="table"><a name="authentication-object-table" href="#authentication-object-table"></a><p class="title"><b>Table&nbsp;9.2.&nbsp;ExpiringUsernameAuthenticationToken values.</b></p><div class="table-contents">
                
                <table summary="ExpiringUsernameAuthenticationToken values." style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-bottom: 0.5pt solid ; " align="left">Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = true (default) - <span class="emphasis"><em>String</em></span> value of <span class="emphasis"><em>NameID</em></span> included in the SAML Assertion (<span class="emphasis"><em>credential.getNameID().getValue()</em></span> of type java.lang.String)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = false AND userDetail = null (default) - <span class="emphasis"><em>NameID</em></span> object included in the SAML Assertion (<span class="emphasis"><em>credential.getNameID()</em></span> of type <span class="emphasis"><em>org.opensaml.saml2.core.NameID</em></span>)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = false AND userDetail != null - <span class="emphasis"><em>UserDetail</em></span> object returned from the <span class="emphasis"><em>SAMLUserDetailsService</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Credentials</td><td style="border-bottom: 0.5pt solid ; " align="left">SAML authentication object including entity ID of local and remote entity, name ID, assertion and relay state (<span class="emphasis"><em>org.springframework.security.saml.SAMLCredential</em></span>)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Authorities</td><td style="border-bottom: 0.5pt solid ; " align="left">Result of <span class="emphasis"><em>getAuthorities()</em></span> call on the <span class="emphasis"><em>UserDetails</em></span> object returned from <span class="emphasis"><em>SAMLUserDetailsService</em></span>, empty list when there's no <span class="emphasis"><em>UserDetail</em></span> object available.</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Expiration</td><td style="" align="left">Value of <span class="emphasis"><em>SessionNotOnOrAfter</em></span> in the SAML Assertion when avaialble, null otherwise. <span class="emphasis"><em>Authentication</em></span> object will start returning false on the <span class="emphasis"><em>isAuthenticated()</em></span> after the expiration time.</td></tr></tbody></table>
            </div></div><p><br class="table-break"></p>
            <p>Custom implementation of the <span class="emphasis"><em>SAMLUserDetailsService</em></span> can be provided as property <span class="emphasis"><em>userDetails</em></span> of the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>.
            Implementation can perform operation such as parsing of attributes present in the SAML Assertion, e.g.:
            </p><pre class="programlisting">package fi.schafer.test.saml;

import org.opensaml.saml2.core.Attribute;
import org.opensaml.xml.XMLObject;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.saml.SAMLCredential;
import org.springframework.security.saml.userdetails.SAMLUserDetailsService;

public class TestUserDetails implements SAMLUserDetailsService {
	@Override
	public Object loadUserBySAML(SAMLCredential cred) throws UsernameNotFoundException {
		return cred.getAttributeAsString("accountID");
	}
}</pre>
            <p>Population of the authentication object can be further customized by overriding of the <span class="emphasis"><em>getUserDetails</em></span>, <span class="emphasis"><em>getPrincipal</em></span>, <span class="emphasis"><em>getEntitlements</em></span> and <span class="emphasis"><em>getExpirationDate</em></span> methods
            in the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>.</p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-authentication-assertion" href="#configuration-authentication-assertion"></a>9.5&nbsp;Authentication assertion</h2></div></div></div>
            
            <p>Assertion used to authenticate user is stored in the <span class="emphasis"><em>SAMLCredential</em></span> object under property <span class="emphasis"><em>authenticationAssertion</em></span>. By default the original content (DOM) of the assertion is discarded and system only keeps an unmarshalled version which might slightly differ from the original, e.g. in white-spaces.
            In order to instruct Spring SAML to keep the assertion in the original form (keep its DOM) set property <span class="emphasis"><em>releaseDOM</em></span> to <span class="emphasis"><em>false</em></span> on bean <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span>.</p>
            <p>Assertion can be serialized to String using the following call:
            </p><pre class="programlisting">XMLHelper.nodeToString(SAMLUtil.marshallMessage(credential.getAuthenticationAssertion()))</pre><p>
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-authentication-log" href="#configuration-authentication-log"></a>9.6&nbsp;Authentication log</h2></div></div></div>
            
            <p>Key events such as single sign-on and single logout initialization, success or failure can be logged for creation of an audit trail.
            A custom logger can be created by implementing interface <span class="emphasis"><em>org.springframework.security.saml.log.SAMLLogger</em></span> and including its bean
            in the <span class="emphasis"><em>securityContext.xml</em></span>, e.g.:</p><pre class="programlisting">&lt;bean id="samlLogger" class="org.springframework.security.saml.log.SAMLDefaultLogger"/&gt;</pre>
            <p>Two basic implementations are provided by default:
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                  <p>org.springframework.security.saml.log.SAMLEmptyLogger</p>
                  <p>Doesn't perform any logging, simply ignores all events.</p>
              </li><li class="listitem">
                  <p>org.springframework.security.saml.log.SAMLDefaultLogger</p>
                  <p>Logs events as INFO level messages to the log name <span class="emphasis"><em>org.springframework.security.saml.log.SAMLDefaultLogger</em></span> configurable as described in <a class="xref" href="#logging" title="6.6&nbsp;Logging">Section&nbsp;6.6, &#8220;Logging&#8221;</a>. Setting
                  property <span class="emphasis"><em>logMessages</em></span> to <span class="emphasis"><em>true</em></span> will include content of the SAML messages as part of the log. Logging of exceptions
            can be disabled by setting <span class="emphasis"><em>logErrors</em></span> to <span class="emphasis"><em>false</em></span>. Fields are semicolon separated with the following values:</p>
                  <div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>type of SAML message (AuthNRequest, AuthNResponse, LogoutRequest or LogoutResponse)</p></li><li class="listitem"><p>result of processing (SUCCESS or FAILURE)</p></li><li class="listitem"><p>IP address of the peer who made the current request to SP</p></li><li class="listitem"><p>entity ID of the local SP</p></li><li class="listitem"><p>entity ID of the remote IDP</p></li><li class="listitem"><p>identifier of the authenticated user</p></li><li class="listitem"><p>SAML message (when logMessages is enabled)</p></li><li class="listitem"><p>text of the error (only for failures, when logErrors is enabled)</p></li></ul></div>
              </li></ul></div>
        <p>The logger is only called for messages which can be correctly received and parsed. For errors which occur before correct parsing see <a class="xref" href="#error-handling" title="6.5&nbsp;Error handling">Section&nbsp;6.5, &#8220;Error handling&#8221;</a>.</p>
        </div>
    </div>

    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="configuration-advanced" href="#configuration-advanced"></a>10.&nbsp;Advanced configuration</h2></div></div></div>
        
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-load-balancing" href="#configuration-load-balancing"></a>10.1&nbsp;Reverse proxies and load balancers</h2></div></div></div>
            
            <p>SAML Extension can be deployed in scenarios where mutliple back-end servers process SAML requests forwarded by a reverse-proxy or a load balancer.
                SSL termination proxies which communicate using an unencrypted channel between the proxy and back-end servers are also supported. In order
                to configure SAML Extension for deployment behind a load balancer or a reverse-proxy please follow these steps:
                </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                        <p>Make sure that your reverse-proxy or load-balancer is configured to use sticky sessions. Information about e.g. sent requests is stored
                            within a user's HTTP session and sending of response to another back-end node would make the original request data unavailable and fail the validation.
                            Sticky session are not necessary in case only IDP-initialized SSO is used or when sessions are replicated to all nodes.</p>
                    </li><li class="listitem">
                        <p>Provide information about front-end URL to the back-end servers by changing the <span class="emphasis"><em>contextProvider</em></span> bean implementation in your <span class="emphasis"><em>securityContext.xml</em></span>
                            to class <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProviderLB</em></span>: </p><pre class="programlisting">&lt;bean id="contextProvider" class="org.springframework.security.saml.context.SAMLContextProviderLB"&gt;
	&lt;property name="scheme" value="https"/&gt;
	&lt;property name="serverName" value="www.myserver.com"/&gt;
	&lt;property name="serverPort" value="443"/&gt;
	&lt;property name="includeServerPortInRequestURL" value="false"/&gt;
	&lt;property name="contextPath" value="/spring-security-saml2-sample"/&gt;
&lt;/bean&gt;</pre>
                        <p>This setting enables the extension to correctly form all generated URLs and verify endpoints of the incoming SAML messages.</p>
                    </li><li class="listitem">
                        <p>In case you use automatically generated metadata make sure to configure <span class="emphasis"><em>entityBaseURL</em></span> matching the front-end URL in your <span class="emphasis"><em>metadataGeneratorFilter</em></span>
                            bean: </p><pre class="programlisting">&lt;bean id="metadataGeneratorFilter"
		class="org.springframework.security.saml.metadata.MetadataGeneratorFilter"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
			&lt;property name="entityBaseURL"
				value="https://www.myserver.com/spring-security-saml2-sample"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
                    </li></ul></div><p>
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-context-provider" href="#configuration-context-provider"></a>10.2&nbsp;Context provider</h2></div></div></div>
            
            <p>Context provider populates information about the local service provider (your application) such as entityId, role, metadata, security keys, SSL credentials
            and trust engines for verification of signatures and SSL/TLS connections. Once populated context is made available to all components participating
            in processing of the incoming or outgoing SAML messages. ContextProvider can customized to alter behavior of the SAML Extension. The default
            implementation <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProviderImpl</em></span> relies on information available in the ExtendedMetadata and
            performs the following steps for creation of the context:
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                        <p>Locate entityId of the local SP by parsing part of the URL after <span class="emphasis"><em>/alias/</em></span> (e.g. myAlias in https://www.myserver.com/saml_extension/saml/sso/alias/myAlias?idp=myIdp) and matching
                        it with property <span class="emphasis"><em>alias</em></span> specified in the ExtendedMetadata. In case the URL doesn't contain any alias part the default service provider
                        configured with property <span class="emphasis"><em>hostedSPName</em></span> on the <span class="emphasis"><em>metadata</em></span> bean is used.</p>
                    </li><li class="listitem">
                        <p>Populate credential used to decrypt data sent to this service provider. In case ExtendedMetadata specifies property <span class="emphasis"><em>encryptionKey</em></span>
                        it will be used as an alias to lookup a private key from the <span class="emphasis"><em>keyManager</em></span> bean. Otherwise defaultKey of the <span class="emphasis"><em>keyManager</em></span> bean will be used.</p>
                    </li><li class="listitem">
                        <p>Populate credential used for SSL/TLS client authentication. In case ExtendedMetadata specifies property <span class="emphasis"><em>tlsKey</em></span> it will be used
                        as an alias to lookup key from <span class="emphasis"><em>keyManager</em></span> bean. Otherwise no credential will be provided for client authentication.</p>
                    </li><li class="listitem">
                        <p>Populate trust engine for verification of signatures. Depending on <span class="emphasis"><em>securityProfile</em></span> setting in the ExtendedMetadata trust engine
                        based on either <a class="xref" href="#configuration-security-profiles-metaiop" title="8.2.1&nbsp;Metadata interoperability profile (MetaIOP)">Section&nbsp;8.2.1, &#8220;Metadata interoperability profile (MetaIOP)&#8221;</a> or <a class="xref" href="#configuration-security-profiles-pkix" title="8.2.2&nbsp;PKIX profile">Section&nbsp;8.2.2, &#8220;PKIX profile&#8221;</a> is created.</p>
                    </li><li class="listitem">
                        <p>Populate trust engine for verification of SSL/TLS connections. Depending on <span class="emphasis"><em>sslSecurityProfile</em></span> setting in the ExtendedMetadata
                        trust engine based on either <a class="xref" href="#configuration-security-profiles-metaiop" title="8.2.1&nbsp;Metadata interoperability profile (MetaIOP)">Section&nbsp;8.2.1, &#8220;Metadata interoperability profile (MetaIOP)&#8221;</a> or <a class="xref" href="#configuration-security-profiles-pkix" title="8.2.2&nbsp;PKIX profile">Section&nbsp;8.2.2, &#8220;PKIX profile&#8221;</a> is created.</p>
                    </li></ul></div>
            <p>During initialization of SSO ContextProvider is also requested to provide metadata of the peer IDP. System performs these steps to locate peer IDP to use:
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
                        <p>Load parameter <span class="emphasis"><em>idp</em></span> of the HttpRequest object and try to locate peer IDP by the entityId. When there's no <span class="emphasis"><em>idp</em></span>
                        parameter provided system will either start IDP discovery process (when enabled in the ExtendedMetadata of the local SP) or use the default IDP specified in the
                        <span class="emphasis"><em>metadata</em></span> bean.</p>
                    </li></ul></div>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="time-interval" href="#time-interval"></a>10.3&nbsp;Validity intervals</h2></div></div></div>
            
            <p>For security reasons system limits the time window enabling processing of SAML messages and assertions. The time window parameters can be customized with the following settings.</p>
            <p>Validity of assertions processed during the signle sign-on process is limited to 3000 seconds. Value can be customized with property <span class="emphasis"><em>maxAssertionTime</em></span>
            of the <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> bean.</p>
            <p>System allows users to single sign-on for up to 7200 seconds since their initial authentication with the IDP (based on value AuthInstance of the Authentication statement).
            Some IDPs allow users to stay authenticated for longer periods than this and you might need to change the default value by setting <span class="emphasis"><em>maxAuthenticationAge</em></span>
            of the <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> bean.</p>
            <p>As clocks between IDP and SP machines may not be perfectly synchronized a tolerance of 60 seconds is applied for time comparisons. The tolerance value (time skew) can be customized
            by settings property <span class="emphasis"><em>responseSkew</em></span> in beans <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> and <span class="emphasis"><em>SingleLogoutProfileImpl</em></span>.</p>
       <p>The following tables summarize all checks for time validity during processing of incoming SAML messages. Response skew refers to property <span class="emphasis"><em>responseSkew</em></span>
       set on profile beans. Past indicates that validity window for checking of the value will be extended by <span class="emphasis"><em>responseSkew</em></span> seconds to the past and correspondingly
       with the future value. Nullable values can be missing from the incoming messages.
                </p><div class="table"><a name="time-skew-overview-authnrespose" href="#time-skew-overview-authnrespose"></a><p class="title"><b>Table&nbsp;10.1.&nbsp;Time checks during processing of incoming SAML Response in WebSSO and WebSSO HoK profiles</b></p><div class="table-contents">
                    
                    <table summary="Time checks during processing of incoming SAML Response in WebSSO and WebSSO HoK profiles" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><tbody><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.issueInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time when SAML response message was created.</td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.issueInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future) + maxAssertionTime (future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time when SAML assertion was created, allows validity extension as assertion might be
                                    re-used by the caller.
                                </td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.subject.subjectConfirmation.notOnOrAfter
                                    </strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time when subject can no longer be confirmed.</td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.authnStatement.authnInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future) + maxAuthenticationAge (future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws CredentialsExpiredException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time when user authenticated to IDP, typically differs from time or response or
                                    assertion creation time.
                                </td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.authnStatement.sessionNotOnOfAfter</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">no skew</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">Yes</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws CredentialsExpiredException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time when user's session expires and requires re-authentication, sessions are
                                    typically valid for longer period and therefore do not suffer from time synchronization
                                    problems.
                                </td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.condition.notBefore</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">Yes</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description:</td><td style="border-bottom: 0.5pt solid ; " align="left">Time limit on validity of assertion.</td></tr><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.assertion.condition.notOnOrAfter</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">Yes</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Description:</td><td style="" align="left">Time limit on validity of assertion.</td></tr></tbody></table>
                </div></div><p><br class="table-break">
                </p><div class="table"><a name="time-skew-overview-logoutrequest" href="#time-skew-overview-logoutrequest"></a><p class="title"><b>Table&nbsp;10.2.&nbsp;Time checks during processing of incoming SAML LogoutRequest in Single Logout profile</b></p><div class="table-contents">
                    
                    <table summary="Time checks during processing of incoming SAML LogoutRequest in Single Logout profile" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><tbody><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.issueInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Sends LogoutResponse with error Status
                                    "urn:oasis:names:tc:SAML:2.0:status:Requester"
                                </td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Description:</td><td style="" align="left">Time when SAML LogoutRequest message was created.</td></tr></tbody></table>
                </div></div><p><br class="table-break">
                </p><div class="table"><a name="time-skew-overview-logoutresponse" href="#time-skew-overview-logoutresponse"></a><p class="title"><b>Table&nbsp;10.3.&nbsp;Time checks during processing of incoming SAML LogoutResponse in Single Logout profile</b></p><div class="table-contents">
                    
                    <table summary="Time checks during processing of incoming SAML LogoutResponse in Single Logout profile" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><tbody><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.issueInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws SAMLException</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Description:</td><td style="" align="left">Time when SAML LogoutResponse message was created.</td></tr></tbody></table>
                </div></div><p><br class="table-break">
                </p><div class="table"><a name="time-skew-overview-artifacteresponse" href="#time-skew-overview-artifacteresponse"></a><p class="title"><b>Table&nbsp;10.4.&nbsp;Time checks during processing of incoming SAML ArtifactResponse in Artifact Resolution profile
                    </b></p><div class="table-contents">
                    
                    <table summary="Time checks during processing of incoming SAML ArtifactResponse in Artifact Resolution profile&#xA;                    " style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><tbody><tr><td style="border-bottom: 0.5pt solid ; " colspan="2" align="left">
                                    <span class="strong"><strong>response.issueInstant</strong></span>
                                </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Applied skew:</td><td style="border-bottom: 0.5pt solid ; " align="left">responseSkew (past + future)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Nullable:</td><td style="border-bottom: 0.5pt solid ; " align="left">No</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Fails with:</td><td style="border-bottom: 0.5pt solid ; " align="left">Throws MessageDecodingException</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Description:</td><td style="" align="left">Time when SAML LogoutResponse message was created.</td></tr></tbody></table>
                </div></div><p><br class="table-break">
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="enhanced-client" href="#enhanced-client"></a>10.4&nbsp;Enhanced client/proxy</h2></div></div></div>
            
            <p>Support for enhanced client/proxy can be configured using property <span class="emphasis"><em>ecpEnabled</em></span> of the service provider's extended metadata. Once enabled, ECP profile is automatically activated with requests containing HTTP headers
            <span class="emphasis"><em>Accept: application/vnd.paos+xml</em></span> and <span class="emphasis"><em>PAOS: ver='urn:liberty:paos:2003-08'; 'urn:oasis:names:tc:SAML:2.0:profiles:SSO:ecp'</em></span>. Binding used to server ECP profile is always automatically set to PAOS.</p>
            <p>ECP can be enabled in combination with the automatic metadata generation using the following settings: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
	&lt;property name="extendedMetadata"&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"&gt;
			&lt;property name="ecpEnabled" value="true"/&gt;
		&lt;/bean&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre><p>
            </p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="endpoint-url" href="#endpoint-url"></a>10.5&nbsp;Endpoint URLs</h2></div></div></div>
            
            <p>By default Spring SAML uses the following endpoints, which can optionally also contain information about <a class="link" href="#configuration-entity-alias" title="7.4&nbsp;Multi-tenancy and entity alias">entity alias</a> of the local Service Provider:
                </p><div class="table"><a name="endpoint-url-overview" href="#endpoint-url-overview"></a><p class="title"><b>Table&nbsp;10.5.&nbsp;Endpoint overview</b></p><div class="table-contents">
                
                <table summary="Endpoint overview" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"><col align="left" class="_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Profile</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Binding</th><th style="border-bottom: 0.5pt solid ; " align="left">Endpoint</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Web Single Sign-on</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">HTTP-POST, HTTP-Artifact, PAOS</td><td style="border-bottom: 0.5pt solid ; " align="left">scheme://server:port/contextPath/saml/SSO</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Web Single Sign-on Holder of Key</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">HTTP-POST, HTTP-Artifact</td><td style="border-bottom: 0.5pt solid ; " align="left">scheme://server:port/contextPath/saml/HoKSSO</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Single Logout</td><td style="border-right: 0.5pt solid ; " align="left">HTTP-POST, HTTP-Redirect</td><td style="" align="left">scheme://server:port/contextPath/saml/SingleLogout</td></tr></tbody></table>
                </div></div><p><br class="table-break">
            </p>
            <p>The default URLs can be altered with these steps:
                </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
                        <p>change property <span class="emphasis"><em>filterProcessesUrl</em></span> on the corresponding processing bean (<span class="emphasis"><em>samlWebSSOProcessingFilter</em></span>, <span class="emphasis"><em>samlWebSSOHoKProcessingFilter</em></span>, <span class="emphasis"><em>samlLogoutProcessingFilter</em></span> or <span class="emphasis"><em>samlIDPDiscovery</em></span>) to the new URL, for example <span class="emphasis"><em>/samlResponse</em></span></p>
                    </li><li class="listitem">
                        <p>update the <span class="emphasis"><em>samlFilter</em></span> bean and make sure that the modified processing filter is mapped to the correct pattern, for example <span class="emphasis"><em>/samlResponse/**</em></span>, the <span class="emphasis"><em>/**</em></span> part is only needed in case you're using the entity alias feature</p>
                    </li><li class="listitem">
                        <p>re-generate metadata for your service provider, in case you are using <a class="link" href="#configuration-metadata-sp-generation" title="7.1.1&nbsp;Automatic metadata generation">automatic metadata generator</a> the endpoints will be automatically generated with the new URLs</p>
                    </li><li class="listitem">
                        <p>in case you are using <a class="link" href="#configuration-metadata-sp-import" title="7.1.2&nbsp;Pre-configured metadata">pre-configured metadata</a> you can perform changes manually in your existing metadata file</p>
                    </li></ul></div><p>
            </p>
            <p>Endpoints of filters <span class="emphasis"><em>samlEntryPoint</em></span>, <span class="emphasis"><em>samlLogoutFilter</em></span> and <span class="emphasis"><em>metadataDisplayFilter</em></span> can be changed using the same process and without need to re-generate the metadata.</p>
        </div>
        <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="artifact-resolution" href="#artifact-resolution"></a>10.6&nbsp;Artifact resolution</h2></div></div></div>
            
            <p>Usage of HTTP-Artifact binding requires Spring SAML to make a direct SOAP call to the Identity Provider. Sometimes it's necessary to configure correct HTTP proxy for the call. This can be achieved
            by setting property <span class="emphasis"><em>hostConfiguration</em></span> on <span class="emphasis"><em>HttpClient</em></span> plugged to the <span class="emphasis"><em>artifactBinding</em></span> bean. The following configuration demonstrates creation of the bean
            for the <span class="emphasis"><em>hostConfiguration</em></span>: </p><pre class="programlisting">&lt;bean id="hostConfiguration" class="org.apache.commons.httpclient.HostConfiguration"/&gt;
&lt;bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"&gt;
	&lt;property name="targetObject" ref="hostConfiguration"/&gt;
	&lt;property name="targetMethod" value="setProxy"/&gt;
	&lt;property name="arguments"&gt;
		&lt;list&gt;
			&lt;value&gt;testHost&lt;/value&gt;
			&lt;value&gt;8080&lt;/value&gt;
		&lt;/list&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre><p>
            </p>
            <p>Another common use-case is situation when artifact resolution endpoint at IDP is secured using HTTP-Basic authentication. Authentication can be configured by setting 
            <span class="emphasis"><em>HTTPClient's</em></span> property <span class="emphasis"><em>state</em></span> with the following bean: </p><pre class="programlisting">&lt;bean id="state" class="org.apache.commons.httpclient.HttpState"/&gt;
&lt;bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean"&gt;
	&lt;property name="targetObject" ref="state"/&gt;
	&lt;property name="targetMethod" value="setCredentials"/&gt;
	&lt;property name="arguments"&gt;
		&lt;list&gt;
			&lt;util:constant static-field="org.apache.commons.httpclient.auth.AuthScope.ANY"/&gt;
			&lt;bean class="org.apache.commons.httpclient.UsernamePasswordCredentials"&gt;
				&lt;constructor-arg value="username"/&gt;
				&lt;constructor-arg value="password"/&gt;
			&lt;/bean&gt;
		&lt;/list&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre><p>
            </p>
        </div>
    </div>

	
  
</div>
		  
	<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="sample-app" href="#sample-app"></a>Part&nbsp;III.&nbsp;Sample application</h1></div></div></div>
		
		<div class="partintro"><div></div>
			<p>Chapter provides reference for the sample application and its administration user interface.</p>
		</div>

		<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-sample-app" href="#chapter-sample-app"></a>11.&nbsp;Sample application</h2></div></div></div>
		
		<p>Spring SAML includes a sample application which demonstrates key capabilities of this product. For details on compilation and deployment of the sample application
    please see <a class="xref" href="#chapter-quick-start" title="4.&nbsp;Quick start guide">Chapter&nbsp;4, <i>Quick start guide</i></a>.</p>
    
    <p>Public demo of the sample application is available at <a class="ulink" href="https://saml-federation.appspot.com" target="_top">saml-federation.appspot.com</a></p>
    
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sample-authentication" href="#sample-authentication"></a>11.1&nbsp;SAML login</h2></div></div></div>
        
        <p>Sample application demonstrates usage of IDP discovery which is automatically invoked on access to the application root. Discovery presents selection of all available Identity Providers
        and initiates SAML 2.0 single sign-on with the selected IDP after clicking on the <span class="emphasis"><em>"Start single sign-on"</em></span> button.</p>
        <p>After authentication at IDP, sample application displays information about the received and validated assertion, or displays errors encountered during validation.</p>
        <p>Clicking buttons <span class="emphasis"><em>"Global Logout"</em></span> and <span class="emphasis"><em>"Local Logout"</em></span> initializes the logout process as described in <a class="xref" href="#configuration-logout" title="9.3&nbsp;Logout process">Section&nbsp;9.3, &#8220;Logout process&#8221;</a>.</p>
    </div>
    
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sample-administration-ui" href="#sample-administration-ui"></a>11.2&nbsp;Metadata administration</h2></div></div></div>
        
        <p>Sample application contains an administration UI which enables simple monitoring and administrative use-cases. You can access the UI by 
        clicking on <span class="emphasis"><em>"Metadata Administration"</em></span> button.</p>
        <p>Administration part is secured with role <span class="emphasis"><em>ROLE_ADMIN</em></span> and uses local authentication with default username <span class="emphasis"><em>admin</em></span> and password <span class="emphasis"><em>admin</em></span>.
        As Spring Security allows only one authentication to be currently active, authenticating to administration UI will remove any previous SAML authentication from the security context.</p>
        <p>Metadata administration enables the following operations:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
					<p>Displaying of existing identity provider and service provider entities by clicking on their identifier. Information includes content of the metadata and extended metadata for the entity.</p>
				</li><li class="listitem">
					<p>Displaying of existing metadata providers and possibility to remove them.</p>
				</li><li class="listitem">
					<p>Refreshing of all metadata providers by clicking on button <span class="emphasis"><em>"Refresh metadata"</em></span>.</p>
				</li><li class="listitem">
					<p>Generation of new metadata by clicking on <span class="emphasis"><em>"Generate new service provider metadata"</em></span>.</p>
				</li></ul></div><p>
        </p>
    </div>
    
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sample-administration-metadata-generation" href="#sample-administration-metadata-generation"></a>11.3&nbsp;Metadata generation</h2></div></div></div>
        
        <p>Metadata generator allows dynamic creation of service provider metadata based on values provided in the UI. Metadata can be immediately applied to the currently
        running instance by setting <span class="emphasis"><em>"Store for current session"</em></span> option to <span class="emphasis"><em>"Yes"</em></span>.</p>
        <p>Options available in the interface are discussed in <a class="xref" href="#configuration-metadata-sp-generation" title="7.1.1&nbsp;Automatic metadata generation">Section&nbsp;7.1.1, &#8220;Automatic metadata generation&#8221;</a> and <a class="xref" href="#configuration-metadata-extended" title="7.3&nbsp;Extended metadata">Section&nbsp;7.3, &#8220;Extended metadata&#8221;</a>.
        The generated values can be used as input for pre-configured metadata described in <a class="xref" href="#configuration-metadata-sp-import" title="7.1.2&nbsp;Pre-configured metadata">Section&nbsp;7.1.2, &#8220;Pre-configured metadata&#8221;</a>.</p>
    </div>
        
</div>
		
	</div>  		
  
	<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="integration" href="#integration"></a>Part&nbsp;IV.&nbsp;Integration guide</h1></div></div></div>
		
		<div class="partintro"><div></div>
			<p>This chapter includes step-by-step instructions on basic steps required for 
      enabling single sign-on with common identity providers.</p>
		</div>

		<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-idp-guide" href="#chapter-idp-guide"></a>12.&nbsp;Integrating Identity Providers</h2></div></div></div>
	
	<p>Section provides additional information regarding integration of Spring SAML with popular Identity Providers.</p>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1748" href="#d5e1748"></a>12.1&nbsp;Active Directory Federation Services 2.0 (AD FS)</h2></div></div></div>
		

			<p>AD FS 2.0 supports SAML 2.0 in IDP mode and can be easily integrated with SAML Extension for both SSO and SLO.
			Before starting with the configuration make sure that the following pre-requisites are satisfied:</p>
			<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
						<p>Install AD FS 2.0 (http://www.microsoft.com/en-us/download/details.aspx?id=10909)</p>
					</li><li class="listitem">
						<p>Run AD FS 2.0 Federation Server Configuration Wizard in the AD FS 2.0 Management Console</p>
					</li><li class="listitem">
						<p>Make sure that DNS name of your Windows Server is available at your SP and vice versa</p>
					</li><li class="listitem">
						<p>Install a Java container (e.g. Tomcat) for deployment of the SAML 2 Extension</p>
					</li><li class="listitem">
						<p>Configure your container to use HTTPS, this is required by AD FS (<a class="ulink" href="http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html" target="_top">http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html</a>)</p>
					</li></ul></div>

			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-idp" href="#chapter-idp-guide-adfs-idp"></a>12.1.1&nbsp;Initialize IDP metadata</h3></div></div></div>
			
			<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
						<p>Download AD FS 2.0 metadata from e.g. <span class="emphasis"><em>https://adfsserver/FederationMetadata/2007-06/FederationMetadata.xml</em></span></p>
					</li><li class="listitem">
						<p>Store the downloaded content to <span class="emphasis"><em>sample/src/main/resources/metadata/FederationMetadata.xml</em></span></p>
					</li><li class="listitem">
						<p>Modify bean <span class="emphasis"><em>metadata</em></span> in <span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span> and replace <span class="emphasis"><em>classpath:security/idp.xml</em></span> with <span class="emphasis"><em>classpath:security/FederationMetadata.xml</em></span> and add property <span class="emphasis"><em>metadataTrustCheck</em></span> to <span class="emphasis"><em>false</em></span> to skip signature validation:
</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.ResourceBackedMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;bean class="java.util.Timer"/&gt;
			&lt;/constructor-arg&gt;
			&lt;constructor-arg&gt;
				&lt;bean class="org.opensaml.util.resource.ClasspathResource"&gt;
					&lt;constructor-arg value="/metadata/FederationMetadata.xml"/&gt;
				&lt;/bean&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
	&lt;property name="metadataTrustCheck" value="false"/&gt;
&lt;/bean&gt;</pre><p>
					</p>
				</li></ul></div>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-sp" href="#chapter-idp-guide-adfs-sp"></a>12.1.2&nbsp;Initialize SP metadata</h3></div></div></div>
		
		<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Deploy SAML 2 Extension war archive from <span class="emphasis"><em>sample/target/spring-security-saml2-sample.war</em></span>, or use embedded Tomcat with command: <span class="emphasis"><em>mvn tomcat7:run</em></span></p>
				</li><li class="listitem">
					<p>Open Spring SAML in browser, e.g. at https://localhost:8443/spring-security-saml2-sample, making sure to use HTTPS protocol</p>
				</li><li class="listitem">
					<p>Click Metadata Administration, login and select item with your server name from the Service providers list</p>
				</li><li class="listitem">
					<p>Store content of the Metadata field to a document metadata.xml and upload it to the AD FS server</p>
				</li><li class="listitem">
					<p>In AD FS 2.0 Management Console select "Add Relying Party Trust"</p>
				</li><li class="listitem">
					<p>Select "Import data about the relying party from a file" and select the metadata.xml file created earlier. Select Next</p>
				</li><li class="listitem">
					<p>The wizard may complain that some content of metadata is not supported. You can safely ignore this warning</p>
				</li><li class="listitem">
					<p>Continue with the wizard. On the "Ready to Add Trust" make sure that tab endpoints contains multiple endpoint values. If not, verify that your metadata was generated with HTTPS protocol URLs</p>
				</li><li class="listitem">
					<p>Leave "Open the Edit Claim Rules dialog" checkbox checked and finish the wizard</p>
				</li><li class="listitem">
					<p>Select "Add Rule", choose "Send LDAP Attributes as Claims" and press Next</p>
				</li><li class="listitem">
					<p>Add NameID as "Claim rule name", choose "Active Directory" as Attribute store, choose "SAM-Account-Name" as LDAP Attribute and "Name ID" as "Outgoing claim type", finish the wizard and confirm the claim rules window, in ADFS 3.0 you might need to configure the Name ID as a Pass Through claim</p>
				</li><li class="listitem">
					<p>Open the provider by double-clicking it, select tab Advanced and change "Secure hash algorithm" to SHA-1</p>
				</li></ul></div>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-test" href="#chapter-idp-guide-adfs-test"></a>12.1.3&nbsp;Test SSO</h3></div></div></div>
		
		<p>Open the Spring SAML sample application at e.g. https://localhost:8443/spring-security-saml2-sample, select your AD FS server and press login. In case Artifact binding
		is used and SSL/TLS certificate of your AD FS is not already trusted, import it to your samlKeystore.jks by following instructions in the
		error report.</p>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1816" href="#d5e1816"></a>12.2&nbsp;Okta</h2></div></div></div>
		

		<p>Okta supports single sign-on to customer specified SAML 2.0 Service Provider applications, such as Spring SAML Extension.
			Before starting with the configuration make sure that the following pre-requisites are satisfied:</p>
		<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
				<p>Have an Okta instance and administration account ready, Okta license must allow you to add custom applications</p>
			</li><li class="listitem">
				<p>Install a Java container (e.g. Tomcat) for deployment of the SAML 2 Extension</p>
			</li></ul></div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-okta-sp" href="#chapter-idp-guide-okta-sp"></a>12.2.1&nbsp;Deploy Spring SAML sample application</h3></div></div></div>
			
			<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Deploy SAML 2 Extension war archive from <span class="emphasis"><em>sample/target/spring-security-saml2-sample.war</em></span>, or use embedded Tomcat with command: <span class="emphasis"><em>mvn tomcat7:run</em></span></p>
				</li><li class="listitem">
					<p>Open Spring SAML in browser, e.g. at http://localhost:8080/spring-security-saml2-sample</p>
				</li><li class="listitem">
					<p>Click Metadata Administration, login and select item with your server name from the Service providers</p>
				</li><li class="listitem">
					<p>Note the <span class="emphasis"><em>Entity ID field</em></span>, and <span class="emphasis"><em>Assertion Consumer Service URL (ACS)</em></span> from the metadata XML, e.g. <span class="emphasis"><em>http://localhost:8080/spring-security-saml2-sample/saml/SSO</em></span></p>
				</li></ul></div>
			<p>Information such as entity ID and URLs of your Spring SAML can be customized, see <a class="xref" href="#configuration-metadata-sp" title="7.1&nbsp;Service provider metadata">Section&nbsp;7.1, &#8220;Service provider metadata&#8221;</a> for details.</p>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-okta-idp" href="#chapter-idp-guide-okta-idp"></a>12.2.2&nbsp;Configure Okta</h3></div></div></div>
			
			<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>Login to Okta as an administrator, select <span class="emphasis"><em>Admin</em></span>, select <span class="emphasis"><em>Applications</em></span> and click <span class="emphasis"><em>Create New App</em></span></p>
				</li><li class="listitem">
					<p>From the list of supported protocols select SAML 2.0 and press <span class="emphasis"><em>Create</em></span></p>
				</li><li class="listitem">
					<p>Define app name (e.g. Spring SAML), optionally define app image and press <span class="emphasis"><em>Next</em></span></p>
				</li><li class="listitem">
					<p>Configure SAML with the following settings:</p>
					<p>
						</p><div class="table"><a name="chapter-idp-guide-okta-settings" href="#chapter-idp-guide-okta-settings"></a><p class="title"><b>Table&nbsp;12.1.&nbsp;</b></p><div class="table-contents">
							<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="_1"><col align="left" class="_2"></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Single Sign on URL</td><td style="border-bottom: 0.5pt solid ; " align="left">Use value noted during Spring SAML initialization, e.g. <span class="emphasis"><em>http://localhost:8080/spring-security-saml2-sample/saml/SSO</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Audience URI (SP Entity ID)</td><td style="border-bottom: 0.5pt solid ; " align="left">Use value noted during Spring SAML initialization, e.g. <span class="emphasis"><em>http://localhost:8080/spring-security-saml2-sample/saml/metadata</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Default RelayState</td><td style="border-bottom: 0.5pt solid ; " align="left">Leave empty, unless you require Okta to provide a value to Spring SAML</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Name ID format</td><td style="border-bottom: 0.5pt solid ; " align="left">Select any of the available options, depending on your requirements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Application username</td><td style="border-bottom: 0.5pt solid ; " align="left">Select any of the available options, depending on your requirements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Response (advanced settings)</td><td style="border-bottom: 0.5pt solid ; " align="left">Select "signed"</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Assertion (advanced settings)</td><td style="border-bottom: 0.5pt solid ; " align="left">Select "signed"</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Authentication context class (advanced settings)</td><td style="border-bottom: 0.5pt solid ; " align="left">Select any of the available options</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Request compression (advanced settings)</td><td style="" align="left">Select "Uncompressed"</td></tr></tbody></table>
						</div></div><p><br class="table-break">
					</p>
				</li><li class="listitem">
					<p>Optionally define attributes to be sent to Spring SAML after single sign-on, and press <span class="emphasis"><em>Next</em></span></p>
				</li><li class="listitem">
					<p>On Feedback page select "This is an internal application that we created" and press <span class="emphasis"><em>Finish</em></span></p>
				</li><li class="listitem">
					<p>Make sure to distribute the newly created application to users you want to use for testing</p>
				</li></ul></div>
			</div>

			<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-okta-spring-import" href="#chapter-idp-guide-okta-spring-import"></a>12.2.3&nbsp;Import Okta metadata to Spring SAML</h3></div></div></div>
				
				<div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem">
					<p>In Okta click link "Identity provider metadata" and store the downloaded content to <span class="emphasis"><em>sample/src/main/resources/metadata/okta.xml</em></span></p>
				</li><li class="listitem">
					<p>In Spring SAML modify bean <span class="emphasis"><em>metadata</em></span> in <span class="emphasis"><em>sample/src/main/webapp/WEB-INF/securityContext.xml</em></span> and replace <span class="emphasis"><em>classpath:security/idp.xml</em></span> with <span class="emphasis"><em>classpath:security/okta.xml</em></span>:
						</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.opensaml.saml2.metadata.provider.ResourceBackedMetadataProvider"&gt;
            &lt;constructor-arg&gt;
                &lt;bean class="java.util.Timer"/&gt;
            &lt;/constructor-arg&gt;
            &lt;constructor-arg&gt;
                &lt;bean class="org.opensaml.util.resource.ClasspathResource"&gt;
                    &lt;constructor-arg value="/metadata/okta.xml"/&gt;
                &lt;/bean&gt;
            &lt;/constructor-arg&gt;
            &lt;property name="parserPool" ref="parserPool"/&gt;
        &lt;/bean&gt;
    &lt;/constructor-arg&gt;
    &lt;constructor-arg&gt;
        &lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;</pre><p>
					</p>
				</li><li class="listitem">
					<p>Restart Spring SAML for the changes to get applied</p>
				</li></ul></div>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-okta-test" href="#chapter-idp-guide-okta-test"></a>12.2.4&nbsp;Test SSO</h3></div></div></div>
			
			<p>Open the Spring SAML sample application at e.g. http://localhost:8080/spring-security-saml2-sample, select your Okta server and press login. Alternatively start IDP-initialized
			single sign-on using <span class="emphasis"><em>App Embed Link</em></span> provided by Okta in application configuration, e.g. <span class="emphasis"><em>https://v7security.okta.com/home/v7security_springsaml_1/0oa4vkeakAsUtZ8AI0y6/39139</em></span>.</p>
		</div>
	</div>
    
    

</div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-troubleshooting" href="#chapter-troubleshooting"></a>13.&nbsp;Troubleshooting common problems</h2></div></div></div>
	
    <div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1929" href="#d5e1929"></a>Time synchronization</h2></div></div></div>
      
      <p>Processing of SAML messages and assertions is often limited to a specific time window which e.g. prevents possibilities of replay attacks.
      Validation of messages can fail when internal clocks of the IDP and SP machines are not synchronized. Make sure to use a       
      <a class="ulink" href="http://www.freebsd.org/doc/handbook/network-ntp.html" target="_top">time synchronization service</a> on all systems in the federation.</p>
    </div>
    
    <div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1933" href="#d5e1933"></a>Error 'InResponseToField doesn't correspond to sent message' during SSO</h2></div></div></div>
      
      <p>Make sure that application uses the same HttpSession during sending of the request and reception of the response. Typically, this problem arises when the auhentication request is initialized 
      from localhost address or http scheme, while response is received at a public host name or https scheme. E.g., when initializing authentication from URL https://host:port/app/saml/login, the response 
      must be received at https://host;port/app/saml/SSO, not http://host:port/app/saml/SSO or https://localhost:port/app/saml/SSO.</p>
      <p>The checking of the InResponseToField can be disabled by re-configuring the context provider as follows:
</p><pre class="programlisting">&lt;bean id="contextProvider" class="org.springframework.security.saml.context.SAMLContextProviderImpl"&gt;
  &lt;property name="storageFactory"&gt;
    &lt;bean class="org.springframework.security.saml.storage.EmptyStorageFactory"/&gt;
  &lt;/property&gt;
&lt;/bean&gt;</pre><p>
      </p>
    </div>
    
    <div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1938" href="#d5e1938"></a>System is redirecting to e.g. localhost address when public facing URL is different</h2></div></div></div>
      
      <p>In case you use <a class="link" href="#configuration-metadata-sp-generation" title="7.1.1&nbsp;Automatic metadata generation">automatic metadata generation</a> make sure to set property entityBaseURL on bean MetadataGenerator to 
      e.g. http://server:port/yourapp or use <a class="link" href="#configuration-metadata-sp-import" title="7.1.2&nbsp;Pre-configured metadata">pre-generated metadata</a>.</p>      
    </div>

    <div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1943" href="#d5e1943"></a>System fails during decryption or encryption of fields, e.g. with 'Failed to decrypt EncryptedData'</h2></div></div></div>
      
      <p>Make sure the <span class="emphasis"><em>Unlimited Strength Jurisdiction Policy Files</em></span> are correctly installed in your JDK. See <a class="xref" href="#quick-start-prerequisites" title="4.1&nbsp;Pre-requisites">Section&nbsp;4.1, &#8220;Pre-requisites&#8221;</a> for details.</p>      
    </div>
    
    <div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1948" href="#d5e1948"></a>My system fails during validation of certificates with errors similar to "PKIX path building failed"</h2></div></div></div>
      
      <p>This is typically caused by misconfiguration of certificates. Either your metadata or keyStore do not contain the correct leaf certificates or CA certificates, or your certificates are invalid.
      You can get additional information by starting your application with flag <span class="emphasis"><em>-Djavax.net.debug=all</em></span>.</p>      
    </div>
    
	
  
</div>

	</div>

</div></body></html>